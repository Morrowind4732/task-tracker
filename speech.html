<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice Flag Tester</title>
<style>
  :root{--accent:#0b74ff;--bg:#f6f7fb;--card:#fff;--muted:#667085;--border:#e4e7ec;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#101828;}
  header{padding:20px 24px 8px;}
  h1{margin:0 0 6px;font-size:32px;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:14px}
  .wrap{padding:0 24px 24px;max-width:1100px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 1px 2px rgba(16,24,40,.04)}
  .items{display:flex;flex-direction:column;gap:14px}
  .row{display:grid;grid-template-columns:minmax(160px,260px) 1fr auto;gap:14px;align-items:center;padding:12px;border:1px solid var(--border);border-radius:14px;background:#fafafa}
  .kind{font-size:12px;font-weight:800;color:#344054}
  .title{font-size:16px;font-weight:800}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #d0d5dd;background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;user-select:none}
  .chip.on{background:#eef4ff;border-color:#c7d7fe}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .mic{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid #d0d5dd;cursor:pointer;font-weight:700}
  .mic .dot{width:10px;height:10px;border-radius:50%;background:#94a3b8}
  .row.listening .mic{border-color:#ffb4b4;box-shadow:0 0 0 4px rgba(255,59,48,.12)}
  .row.listening .mic .dot{background:#ff3b30;animation:pulse 1s infinite alternate}
  @keyframes pulse{from{transform:scale(.9)}to{transform:scale(1.2)}}
  input[type=range]{width:240px}
  .score{font-weight:800;min-width:44px;text-align:right;font-variant-numeric:tabular-nums}
  .tiny{color:var(--muted);font-size:12px}
  .bar{display:flex;gap:10px;align-items:center;padding:0 24px 12px}
  .status{color:var(--muted);font-weight:700}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
</style>
</head>
<body>
  <header>
    <h1>Voice Flag Tester</h1>
    <div class="sub">Click a row‚Äôs üé§ to speak; that utterance applies only to that row. You can say multiple flags and a score in one go.</div>
  </header>
  <div class="bar">
    <button id="clearBtn" class="btn">Clear all</button>
    <div id="status" class="status">Status: idle</div>
  </div>

  <div class="wrap">
    <div class="card">
      <div id="items" class="items"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>Say things like‚Ä¶</strong>
      <ul class="tiny">
        <li>‚Äúflag big hunt and overran, rating seven point five‚Äù</li>
        <li>‚Äúremove didn‚Äôt mark and poor initial, increase by point five‚Äù</li>
        <li>‚Äúclear flags, score 6‚Äù</li>
        <li>‚Äú7.5‚Äù (just a number sets the score)</li>
      </ul>
      <div class="tiny">
        Flags: Big Hunt, Marginal Hunt, Overran, Short Checkdown, Backside of Gun, Handled, Cast Refusal, Sit on Whistle, Didn‚Äôt Mark, Poor Initial, Headswing, Broke, Switched, No-Go, Poison Pick Up, No Pick Up, Stood Out, Popped.
      </div>
    </div>
  </div>

<script>
/* ---------------- Flag dictionary with generous patterns ---------------- */
const FLAGS = [
  { key:'bigHunt',        label:'Big Hunt',         rx:[/big\s*hunt/] },
  { key:'marginalHunt',   label:'Marginal Hunt',    rx:[/marginal\s*hunt/] },
  { key:'overran',        label:'Overran',          rx:[/\boverran\b|\bover[-\s]?ran\b|\bover[-\s]?run\b/] },
  { key:'shortCheckDown', label:'Short Checkdown',  rx:[/short\s*check\s*down|short\s*checkdown/] },
  { key:'backSideOfGun',  label:'Backside of Gun',  rx:[/back\s*side\s*of\s*gun|backside\s*of\s*gun/] },

  { key:'handled',        label:'Handled',          rx:[/\bhandled?\b/] },
  { key:'castRefusal',    label:'Cast Refusal',     rx:[/cast\s*refusal/] },
  { key:'sitOnWhistle',   label:'Sit on Whistle',   rx:[/sit\s*on\s*whistle/] },
  { key:'didntMark',      label:"Didn't Mark",      rx:[/didn'?t\s*mark|didnt\s*mark/] }, // apostrophe optional
  { key:'poorInitial',    label:'Poor Initial',     rx:[/poor\s*initial/] },

  { key:'headswing',      label:'Headswing',        rx:[/head\s*swing|headswing/] },
  { key:'break',          label:'Broke',            rx:[/\bbroke?\b|\bbreak\b/] },
  { key:'switched',       label:'Switched',         rx:[/\bswitch(?:ed|)\b/] },
  { key:'noGo',           label:'No-Go',            rx:[/\bno[-\s]?go\b/] },

  { key:'pickedUpPoison', label:'Poison Pick Up',   rx:[/poison\s*pick\s*up|picked\s*up\s*poison/] },
  { key:'noPickUp',       label:'No Pick Up',       rx:[/\bno\s*pick\s*up\b|\bno\s*pickup\b/] },
  { key:'stoodOut',       label:'Stood Out',        rx:[/stood\s*out/] },
  { key:'popped',         label:'Popped',           rx:[/\bpopped?\b/] },
];
const FLAG_MAP = Object.fromEntries(FLAGS.map(f=>[f.key,f]));

/* ---------------- Demo data ---------------- */
const items = [
  { id:'m1', kind:'Mark',  title:'#1 ‚Äî 78 yards',  score:0, flags:{} },
  { id:'m2', kind:'Mark',  title:'#2 ‚Äî 49 yards',  score:0, flags:{} },
  { id:'m3', kind:'Mark',  title:'#3 ‚Äî 143 yards', score:0, flags:{} },
  { id:'b1', kind:'Blind', title:'#1 ‚Äî 120 yards', score:0, flags:{} },
  { id:'b2', kind:'Blind', title:'#2 ‚Äî 95 yards',  score:0, flags:{} },
];

/* ---------------- UI ---------------- */
const itemsEl = document.getElementById('items');
const statusEl = document.getElementById('status');

function chip(key,on){
  const el=document.createElement('span');
  el.className='chip'+(on?' on':'');
  el.dataset.key=key;
  el.textContent=FLAG_MAP[key].label;
  return el;
}

function renderRow(it){
  const row=document.createElement('div'); row.className='row'; row.id='row-'+it.id;

  const left=document.createElement('div');
  left.innerHTML=`<div class="kind">${it.kind}</div><div class="title">${it.title}</div>`;

  const mid=document.createElement('div');
  const chips=document.createElement('div'); chips.className='chips';
  FLAGS.forEach(f=> chips.appendChild(chip(f.key, !!it.flags[f.key])));
  mid.appendChild(chips);

  const right=document.createElement('div'); right.className='controls';
  const mic=document.createElement('button'); mic.type='button'; mic.className='mic';
  mic.innerHTML='<span class="dot"></span> üé§ Listen';
  mic.addEventListener('click',()=>startListeningFor(it.id));
  const slider=document.createElement('input'); slider.type='range'; slider.min='0'; slider.max='10'; slider.step='0.5'; slider.value=it.score;
  slider.addEventListener('input',()=>{ it.score=+slider.value; score.textContent=it.score.toFixed(1); });
  const score=document.createElement('div'); score.className='score'; score.textContent=it.score.toFixed(1);
  right.append(mic,slider,score);

  row.append(left,mid,right);
  itemsEl.appendChild(row);
}

function renderAll(){ itemsEl.innerHTML=''; items.forEach(renderRow); }
renderAll();

/* ---------------- Speech engine ---------------- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec=null, activeId=null;

if (SR){
  rec=new SR(); rec.lang='en-US'; rec.interimResults=false; rec.continuous=false;
  rec.onstart=()=>setStatus('listening‚Ä¶');
  rec.onerror=e=>{ setStatus('error: '+(e.error||'unknown')); endListen(); };
  rec.onend=()=>{ setStatus('idle'); endListen(); };
  rec.onresult=e=>{
    const tx=[...e.results].map(r=>r[0].transcript).join(' ').trim();
    if (activeId) applyTranscript(activeId, tx);
  };
}else{
  setStatus('Speech API not supported in this browser.');
}

function setStatus(s){ statusEl.textContent='Status: '+s; }
function startListeningFor(id){
  if(!rec){ alert('Speech API not supported'); return; }
  try{ rec.abort(); }catch{}
  activeId=id;
  document.querySelectorAll('.row').forEach(r=>r.classList.toggle('listening', r.id==='row-'+id));
  rec.start();
}
function endListen(){
  activeId=null;
  document.querySelectorAll('.row').forEach(r=>r.classList.remove('listening'));
}

/* ---------------- NLP: numbers & intents (multi-flag) ---------------- */
const NUM_WORDS = {
  zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9, ten:10,
  eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19,
  twenty:20, half:0.5
};

function normalize(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[‚Äô‚Äò']/g,"'")         // unify apostrophes
    .replace(/[^a-z0-9.\s-]/g,' ') // drop punctuation (keep dot)
    .replace(/\s+/g,' ')
    .trim();
}

function wordsToNumber(s){
  s=normalize(s);
  if(/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);

  const tok=s.split(/\s+/);
  // ‚Äúseven point five‚Äù
  const i=tok.indexOf('point');
  if(i>-1){
    const A=tok.slice(0,i).join(' ');
    const B=tok.slice(i+1).join(' ');
    const ia=NUM_WORDS[A]; const ib=NUM_WORDS[B];
    if(Number.isFinite(ia) && Number.isFinite(ib)) return +(ia + '.' + Math.round(ib*10));
  }
  if(s in NUM_WORDS) return NUM_WORDS[s];
  return NaN;
}

function quant05(n){ return Math.max(0, Math.min(10, Math.round(n*2)/2)); }

function detectFlags(tx){
  const found=new Set();
  FLAGS.forEach(f=>{ if(f.rx.some(rx=>rx.test(tx))) found.add(f.key); });
  return [...found];
}

/* Parse one utterance ‚Üí { add:Set, remove:Set, toggle:Set, clearAll:bool, score:number|null, adjust:+/- } */
function parseUtterance(raw){
  const tx=normalize(raw);

  const intents={ add:new Set(), remove:new Set(), toggle:new Set(), clearAll:false, score:null, adjust:0 };
  if(/\bclear\s+flags?\b/.test(tx)) intents.clearAll=true;

  const keys=detectFlags(tx);
  const isRemove=/\b(remove|clear|unset|delete)\b/.test(tx);
  const isAdd=/\b(add|flag|set)\b/.test(tx);
  keys.forEach(k=>{
    if(isRemove) intents.remove.add(k);
    else if(isAdd) intents.add.add(k);
    else intents.toggle.add(k); // default = toggle
  });

  // score: explicit ‚Äúrating/score/set ‚Ä¶ <num>‚Äù
  let m=tx.match(/\b(?:rating|score|set|make)\b(?:\s*(?:it|to|at))?\s+([a-z0-9.\s-]+)(?!.*\b(?:by)\b)/);
  if(m){
    const n=wordsToNumber(m[1].trim());
    if(Number.isFinite(n)) intents.score = quant05(n);
  }else{
    // bare number only? (no ‚Äúincrease by‚Äù or ‚Äúdecrease by‚Äù present)
    if(/^\d+(\.\d+)?$/.test(tx) || (wordsToNumber(tx), Number.isFinite(wordsToNumber(tx)))){
      const n=wordsToNumber(tx);
      if(Number.isFinite(n)) intents.score=quant05(n);
    }
  }

  // adjustments
  const inc=tx.match(/\b(increase|raise|up|\+|plus)\b(?:.*?\bby\b)?\s*([a-z0-9.\s-]+)?/);
  const dec=tx.match(/\b(decrease|lower|down|-|minus)\b(?:.*?\bby\b)?\s*([a-z0-9.\s-]+)?/);
  if(inc && !dec){
    const amt = inc[2] ? (Number.isFinite(wordsToNumber(inc[2])) ? wordsToNumber(inc[2]) : parseFloat(inc[2])) : 0.5;
    intents.adjust += Number.isFinite(amt) ? amt : 0.5;
  }
  if(dec && !inc){
    const amt = dec[2] ? (Number.isFinite(wordsToNumber(dec[2])) ? wordsToNumber(dec[2]) : parseFloat(dec[2])) : 0.5;
    intents.adjust -= Number.isFinite(amt) ? amt : 0.5;
  }

  return intents;
}

/* ---------------- Apply to row (multi actions in one go) ---------------- */
function applyTranscript(itemId, raw){
  const it=items.find(x=>x.id===itemId); if(!it) return;
  const intents=parseUtterance(raw);

  if(intents.clearAll) it.flags = {};

  intents.add.forEach(k => it.flags[k]=true);
  intents.remove.forEach(k => it.flags[k]=false);
  intents.toggle.forEach(k => it.flags[k]=!it.flags[k]);

  if(Number.isFinite(intents.score)) it.score=intents.score;
  if(intents.adjust!==0) it.score=quant05(it.score + intents.adjust);

  syncRow(it);
}

function syncRow(it){
  const row=document.getElementById('row-'+it.id);
  if(!row) return;
  row.querySelector('input[type=range]').value=it.score;
  row.querySelector('.score').textContent=it.score.toFixed(1);
  row.querySelectorAll('.chip').forEach(ch=>{
    const k=ch.dataset.key;
    ch.classList.toggle('on', !!it.flags[k]);
  });
}

/* ---------------- Clear all ---------------- */
document.getElementById('clearBtn').addEventListener('click',()=>{
  items.forEach(it=>{ it.flags={}; it.score=0; syncRow(it); });
  setStatus('cleared');
});
</script>
</body>
</html>
