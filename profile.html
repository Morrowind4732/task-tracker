<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kennel</title>

<!-- Chart.js for graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; margin: 16px; }
  .card { max-width: 820px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
  .hero { display: grid; grid-template-columns: 160px 1fr; gap: 16px; align-items: center; }
  .hero img { width:160px; height:160px; object-fit:cover; border-radius:12px; border:1px solid #ccc; }
  .badges { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .badge { padding:4px 8px; border:1px solid #bbb; border-radius:999px; font-size:12px; }
  .section { margin-top: 16px; }
  .section h3 { margin: 0 0 8px; }
  .ratings { display:grid; grid-template-columns: 1fr; gap:12px; }
  .rating-row { display:flex; align-items:center; gap:12px; }
  .label { width: 110px; font-weight: 600; }
  .stars { display:inline-flex; gap:8px; }
  .star-svg { width: 40px; height: 40px; cursor: pointer; }
  textarea { width: 100%; min-height: 96px; box-sizing: border-box; padding: 10px; font-size: 16px; border:1px solid #bbb; border-radius:8px; }
  .actions { display:flex; gap:10px; margin-top:12px; }
  .btn {
    appearance: none; border:1px solid #bbb; background:#fff;
    padding:10px 14px; border-radius:10px; font-size:16px; cursor:pointer;
  }
  .btn.primary { background:#0b74ff; color:#fff; border-color:#0b74ff; }
  .muted { color:#666; font-size:12px; margin-top:8px; }
</style>

<div class="card" id="card">Loadingâ€¦</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, getDoc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
    authDomain: "task-tracker-73b77.firebaseapp.com",
    projectId: "task-tracker-73b77",
    storageBucket: "task-tracker-73b77.firebasestorage.app",
    messagingSenderId: "795274673000",
    appId: "1:795274673000:web:0ea07130e45c72384134dd",
    measurementId: "G-VLW5KLY4FF"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const params  = new URL(location.href).searchParams;
  const trailer = params.get('trailer');
  const slotId  = params.get('slot');
  const cardEl  = document.getElementById('card');
  const CAMERA_URL = "https://morrowind4732.github.io/task-tracker/Camera.html";

  if (!trailer || !slotId) {
    cardEl.textContent = "Missing trailer or slot in URL.";
    throw new Error("Missing params");
  }

  const ratingState = { marks: 0, blinds: 0, behavior: 0, notes: "" };
  let currentDog = { id: null, name: null, profile: null };

  function nameToId(name){
    return String(name||"").toLowerCase().trim()
      .replace(/[\s_]+/g, '-').replace(/[^a-z0-9-]/g, '')
      .replace(/-{2,}/g, '-').replace(/^-+|-+$/g, '');
  }
  function todayLocalYYYYMMDD() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function renderStars(name, current) {
    let html = `<div class="rating-row">
      <div class="label">${name[0].toUpperCase()+name.slice(1)}</div>
      <div class="stars" data-field="${name}">`;

    for (let i = 1; i <= 5; i++) {
      const fillPercent = (current >= i) ? 100 : (current >= i - 0.5 ? 50 : 0);
      html += `
        <svg class="star-svg" viewBox="0 0 24 24" data-value="${i}">
          <defs>
            <linearGradient id="grad-${name}-${i}" x1="0" x2="1" y1="0" y2="0">
              <stop offset="${fillPercent}%" stop-color="#f39c12"/>
              <stop offset="${fillPercent}%" stop-color="#ccc"/>
            </linearGradient>
          </defs>
          <path fill="url(#grad-${name}-${i})" stroke="#999" stroke-width="1"
            d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.834 
               1.516 8.26L12 18.896l-7.452 4.504 
               1.516-8.26L.0 9.306l8.332-1.151z"/>
        </svg>`;
    }
    html += `</div></div>`;
    return html;
  }

  function attachStarHandlers() {
    document.querySelectorAll('.stars').forEach(starRow => {
      starRow.addEventListener('click', e => {
        const star = e.target.closest('.star-svg');
        if (!star) return;

        const value = Number(star.dataset.value);
        const field = starRow.dataset.field;
        const current = ratingState[field] || 0;

        if (current >= value) {
          ratingState[field] = 0;
        } else if (current >= value - 0.5) {
          ratingState[field] = value;
        } else {
          ratingState[field] = value - 0.5;
        }

        renderProfileCard(currentDog.profile, trailer, slotId);
      });
    });
  }

  async function loadTodayIfExists() {
    if (!currentDog.id) return;
    const date = todayLocalYYYYMMDD();
    const ref = doc(db, "ratings", currentDog.id, "days", date);
    const snap = await getDoc(ref);
    if (snap.exists()) Object.assign(ratingState, snap.data());
  }

  async function saveAndGoCamera() {
    if (!currentDog.id) currentDog.id = nameToId(currentDog.name || "");
    const status = document.getElementById('saveStatus');
    status.textContent = "Savingâ€¦";
    const date = todayLocalYYYYMMDD();
    const ref  = doc(db, "ratings", currentDog.id, "days", date);
    const payload = { ...ratingState, dogId: currentDog.id, dogName: currentDog.name || null, trailer, slotId, date, updatedAt: serverTimestamp() };
    try {
      await setDoc(ref, payload, { merge: true });
      status.textContent = "Saved. Redirecting to cameraâ€¦";
      setTimeout(() => location.href = CAMERA_URL, 120);
    } catch (e) {
      console.error(e);
      status.textContent = "Failed to save.";
    }
  }

  function renderProfileCard(profile, trailer, slotId) {
    currentDog.profile = profile;
    cardEl.innerHTML = `
      <div class="hero">
        <img src="${profile?.photo||''}" alt="">
        <div>
          <h1 style="margin:0 0 4px">${profile?.name || currentDog.name || 'Unassigned'}</h1>
          <div>${[profile?.breed, (profile?.age!=null?`${profile.age} yrs`:null)].filter(Boolean).join(' Â· ')}</div>
          <div class="badges">${(profile?.tags||[]).map(t=>`<span class="badge">${t}</span>`).join('')}</div>
          <div class="muted">Trailer: ${trailer} Â· Slot: ${slotId}</div>
        </div>
      </div>

      <div class="section">
        <h3>Ratings (today)</h3>
        <div class="ratings">
          ${renderStars('marks',    ratingState.marks)}
          ${renderStars('blinds',   ratingState.blinds)}
          ${renderStars('behavior', ratingState.behavior)}
        </div>
      </div>

      <div class="section">
        <h3>Notes</h3>
        <textarea id="notesBox" placeholder="Additional comments...">${ratingState.notes||''}</textarea>
      </div>

      <div class="actions">
        <button class="btn primary" id="saveBtn">ðŸ’¾ Save & Camera</button>
        <a class="btn" id="cameraBtn" href="${CAMERA_URL}">ðŸ“· Camera (no save)</a>
      </div>
      <div class="muted" id="saveStatus"></div>

      <!-- Ratings Graphs Card -->
      <div class="card" style="margin-top:20px;">
        <h3>Ratings Overview</h3>
        <div>
          <label><input type="radio" name="graphRange" value="weekly" checked> Weekly</label>
          <label><input type="radio" name="graphRange" value="monthly"> Monthly</label>
        </div>
        <canvas id="marksChart" height="150"></canvas>
        <canvas id="blindsChart" height="150"></canvas>
        <canvas id="behaviorChart" height="150"></canvas>
      </div>

      <!-- Report Lookup Card -->
      <div class="card" style="margin-top:20px;">
        <h3>View Past Report</h3>
        <input type="date" id="reportDate" />
        <button class="btn" id="loadReportBtn">Load</button>
        <div id="reportResult" style="margin-top:10px; font-size:14px; color:#333;"></div>
      </div>
    `;
    attachStarHandlers();
    document.getElementById('notesBox').addEventListener('input', e => ratingState.notes = e.target.value);
    document.getElementById('saveBtn').onclick = saveAndGoCamera;
  }

  // Chart + Report logic
  let marksChart, blindsChart, behaviorChart;

  async function fetchRatingsData(daysBack) {
    if (!currentDog.id) return [];
    const today = new Date();
    const results = [];
    for (let i = daysBack - 1; i >= 0; i--) {
      const d = new Date();
      d.setDate(today.getDate() - i);
      const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const snap = await getDoc(doc(db, "ratings", currentDog.id, "days", dateStr));
      if (snap.exists()) {
        results.push({ date: dateStr, ...snap.data() });
      } else {
        results.push({ date: dateStr, marks: 0, blinds: 0, behavior: 0 });
      }
    }
    return results;
  }

  function renderCharts(data) {
    const labels = data.map(d => d.date);
    const marksData = data.map(d => d.marks || 0);
    const blindsData = data.map(d => d.blinds || 0);
    const behaviorData = data.map(d => d.behavior || 0);

    const commonOptions = {
      responsive: true,
      scales: { y: { min: 0, max: 5, ticks: { stepSize: 0.5 } } }
    };

    if (marksChart) marksChart.destroy();
    if (blindsChart) blindsChart.destroy();
    if (behaviorChart) behaviorChart.destroy();

    marksChart = new Chart(document.getElementById('marksChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Marks', data: marksData, borderColor: '#f39c12', fill: false }] },
      options: commonOptions
    });
    blindsChart = new Chart(document.getElementById('blindsChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Blinds', data: blindsData, borderColor: '#3498db', fill: false }] },
      options: commonOptions
    });
    behaviorChart = new Chart(document.getElementById('behaviorChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Behavior', data: behaviorData, borderColor: '#2ecc71', fill: false }] },
      options: commonOptions
    });
  }

  async function updateCharts(range) {
    const daysBack = range === 'weekly' ? 7 : new Date().getDate();
    const data = await fetchRatingsData(daysBack);
    renderCharts(data);
  }

  document.addEventListener('click', async e => {
    if (e.target.id === 'loadReportBtn') {
      const date = document.getElementById('reportDate').value;
      if (!date || !currentDog.id) return;
      const snap = await getDoc(doc(db, "ratings", currentDog.id, "days", date));
      const resultDiv = document.getElementById('reportResult');
      if (snap.exists()) {
        const data = snap.data();
        resultDiv.innerHTML = `
          <strong>${date}</strong><br>
          Marks: ${data.marks || 0}<br>
          Blinds: ${data.blinds || 0}<br>
          Behavior: ${data.behavior || 0}<br>
          Notes: ${data.notes || ''}
        `;
      } else {
        resultDiv.textContent = "No data found for that date.";
      }
    }
  });

  document.addEventListener('change', e => {
    if (e.target.name === 'graphRange') {
      updateCharts(e.target.value);
    }
  });

  // Always fresh dog for slot
  const slotRef = doc(db, "trailerLayouts", trailer, "slots", slotId);
  onSnapshot(slotRef, async (snap) => {
    let profileData = null;
    currentDog = { id: null, name: null, profile: null };
    if (snap.exists()) {
      const data = snap.data();
      currentDog.name = data.dogName || null;
      currentDog.id   = data.dogId || (data.dogName ? nameToId(data.dogName) : null);
      if (currentDog.id) {
        const profSnap = await getDoc(doc(db, "profiles", currentDog.id));
        if (profSnap.exists()) profileData = profSnap.data();
      }
    }
    await loadTodayIfExists();
    renderProfileCard(profileData, trailer, slotId);
    if (currentDog.id) {
      updateCharts('weekly');
    }
  });
</script>
