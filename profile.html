<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scoring V2</title>

<style>
  :root { --gap:12px; --border:#ddd; --chip-bg:#f5f5f7; --accent:#0b74ff; }
  body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; color:#111; }
  .title-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .mini-link { font-size:12px; color:var(--accent); text-decoration:underline; }
  .mini-link:visited { color:var(--accent); }
  .muted { color:#666; font-size:12px; }

  .btn { appearance:none; border:1px solid #bbb; background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  .btn.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
  .btn.ghost { background:#fff; border-color:#ccc; }

  .section { border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:14px; background:#fff; }

  /* Tabs / day */
  .tabs-bar { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .tabs { display:flex; align-items:flex-end; gap:6px; flex-wrap:wrap; }
  .tab { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#f6f6f6; cursor:pointer; font-weight:600; color:#444; }
  .tab.active { background:#fff; color:#111; box-shadow:0 -1px 0 #fff inset; }

  /* Hero / dog card */
  .hero { display:grid; grid-template-columns: 120px 1fr; gap: 12px; align-items:center; }
  .hero img { width:120px; height:120px; object-fit:cover; border-radius:10px; border:1px solid #ccc; background:#fafafa; }

  /* Scores list */
  .score-list { display:flex; flex-direction:column; gap:12px; }
  .score-card {
    border:1px solid #e2e2e2; border-radius:10px; padding:10px; background:#fafafa;
    display:grid; gap:8px; grid-template-columns: 1fr;
  }
  .score-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .score-title { font-weight:700; }
  .slider-row { display:flex; align-items:center; gap:10px; }
  .slider-row input[type="range"] { flex:1; }
  .slider-val { width:52px; text-align:right; font-variant-numeric: tabular-nums; }
  .flag-btn { padding:10px 14px; border-radius:999px; font-weight:600; }

  .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px; }

  /* Pane tabs (Marks/Blinds) */
  .mini-tabs { display:flex; gap:6px; align-items:center; margin-top:8px; }
  .mini-tab { padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f7f7f7; font-weight:600; cursor:pointer; }
  .mini-tab.active { background:#fff; border-color:#bbb; box-shadow:0 1px 0 rgba(0,0,0,.05); }

  /* ===== Radial flags overlay (CROSS layout) ===== */
  .overlay { position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:center; justify-content:center; z-index:9999; }
  .overlay.open { display:flex; }

  .wheel-wrap { position:relative; width:320px; height:320px; }
  .wheel {
    position:absolute; inset:0; margin:auto;
    width:320px; height:320px; border-radius:50%;
    background:radial-gradient(ellipse at center, #fff, #f4f4f4 60%);
    border:1px solid #e6e6e6;
    box-shadow:0 18px 60px rgba(0,0,0,.28);
    overflow:visible; /* let buttons extend past circle */
  }

  .wheel-title {
    position:absolute; top:-42px; left:50%; transform:translateX(-50%);
    font-weight:800; font-size:16px; color:#222; text-align:center;
    text-shadow:0 1px 0 #fff;
  }

  .center-btn {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:140px; height:140px; border-radius:50%;
    background:#fff; border:1px solid #e5e5e5;
    box-shadow:0 10px 28px rgba(0,0,0,.20);
    font-weight:800;
  }

  .rad-btn {
    position:absolute;
    padding:12px 16px;
    min-width:144px; height:48px;
    border-radius:12px; border:1px solid #dcdcdc; background:#fff;
    box-shadow:0 10px 24px rgba(0,0,0,.16);
    font-weight:700; white-space:nowrap;
  }
  .rad-btn.active { background:#0b74ff; border-color:#0b74ff; color:#fff; box-shadow:0 10px 24px rgba(11,116,255,.32); }

  @media (max-width:380px){
    .wheel-wrap, .wheel { width:300px; height:300px; }
    .center-btn { width:132px; height:132px; }
    .rad-btn { min-width:132px; height:46px; }
  }
</style>
</head>
<body>
  <div class="title-row">
    <h1>Scoring V2</h1>
    <a id="changeUserLink" class="mini-link" href="#">change user</a>
  </div>
  <div class="muted" id="ctx">Loadingâ€¦</div>

  <!-- Trainer chooser overlay -->
  <div class="overlay" id="trainerOverlay">
    <div style="background:#fff; padding:18px; border-radius:12px; min-width:280px; border:1px solid #e5e5e5; box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <h3 style="margin:0 0 10px">Who are you?</h3>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn primary" data-trainer="Scott">Scott</button>
        <button class="btn primary" data-trainer="Cody">Cody</button>
        <button class="btn primary" data-trainer="Brian">Brian</button>
      </div>
    </div>
  </div>

  <!-- Date / Tabs -->
  <div class="section">
    <div class="tabs-bar">
      <div style="margin-right:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Day: <input type="date" id="dayPicker"></label>
        <button class="btn ghost" id="todayBtn">Today</button>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </div>

  <!-- Dog hero -->
  <div class="section" id="dogCard">Loading dogâ€¦</div>

  <!-- Scores -->
  <div class="section" id="scoresSection">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <strong id="scoresTitle"></strong>
      <div class="mini-tabs" id="paneTabs">
        <button class="mini-tab active" data-pane="marks">Marks</button>
        <button class="mini-tab" data-pane="blinds">Blinds</button>
      </div>
    </div>
    <div class="score-list" id="scoreList"></div>
    <div class="actions">
      <button class="btn primary" id="saveCameraBtn">ðŸ’¾ Save & Camera</button>
      <a class="btn" id="cameraOnlyBtn" href="https://morrowind4732.github.io/task-tracker/Camera.html">ðŸ“· Camera (no save)</a>
      <button class="btn" id="saveOnlyBtn">ðŸ’¾ Save</button>
      <span class="muted" id="saveStatus"></span>
    </div>
  </div>

  <!-- Radial overlay -->
  <div class="overlay" id="radialOverlay" aria-hidden="true">
    <div class="wheel-wrap">
      <div class="wheel" id="wheel">
        <div class="wheel-title" id="wheelTitle">Flags</div>
        <button class="center-btn" id="centerCancel">Cancel</button>
        <!-- buttons injected by JS and positioned -->
      </div>
    </div>
  </div>

  <!-- Firebase (v10 modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp,
      collection, query, orderBy, collectionGroup, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    /* ---------------- Firebase init ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.firebasestorage.app",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------------- Utilities & constants ---------------- */
    const ctxEl = document.getElementById('ctx');
    function ymd(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
    function slug(s){
      return String(s||"").toLowerCase().trim()
        .replace(/[\s_]+/g,'-').replace(/[^a-z0-9-]/g,'')
        .replace(/-{2,}/g,'-').replace(/^-+|-+$/g,'');
    }
    const SAVE_DEBOUNCE_MS = 400;

    // Full labels
    const FLAG_DEFS_MARKS = [
      { key:'headswing',       label:'Headswing' },
      { key:'shortCheckDown',  label:'Short Check Down' },
      { key:'overran',         label:'Overran' },
      { key:'bigHunt',         label:'Big Hunt' },
      { key:'handled',         label:'Handled' },
      { key:'castRefusal',     label:'Cast Refusal' },
      { key:'sitOnWhistle',    label:'Sit On Whistle' },
      { key:'backSideOfGun',   label:'Back Side of Gun' },
      { key:'break',           label:'Break' },
      { key:'skipped',         label:'Skipped' },
    ];
    const FLAG_DEFS_BLINDS = [
      { key:'poorInitial',     label:'Poor Initial' },
      { key:'scallop',         label:'Scallop' },
      { key:'castRefusal',     label:'Cast Refusal' },
      { key:'pickedUpPoison',  label:'Picked Up Poison' },
      { key:'hunted',          label:'Hunted' },
      { key:'ignoredWhistle',  label:'Ignored Whistle' },
      { key:'failedDiversion', label:'Failed Diversion' },
      { key:'skipped',         label:'Skipped' },
    ];

    /* ---------------- URL params (QR compatible) ---------------- */
    const params  = new URL(location.href).searchParams;
    const trailer = (params.get('trailer')||'').trim();
    const sex     = (params.get('sex')||'').trim();
    const slotNum = (params.get('slot')||'').trim();
    const trailerNorm = trailer.toLowerCase();
    const sexNorm     = sex.toLowerCase();
    const trailerPrefix = trailerNorm.charAt(0).toUpperCase();
    const sexPrefix     = sexNorm.charAt(0).toUpperCase();
    const slotId        = `${trailerPrefix}_${sexPrefix}_${slotNum}`;

    /* ---------------- Trainer picker ---------------- */
    const overlayPick = document.getElementById('trainerOverlay');
    const changeUserLink = document.getElementById('changeUserLink');
    changeUserLink.addEventListener('click', (e) => {
      e.preventDefault();
      const url = new URL(location.href);
      url.searchParams.delete('trainer');
      history.replaceState(null, '', url.toString());
      showTrainerPrompt();
    });
    function showTrainerPrompt(){
      overlayPick.classList.add('open');
      overlayPick.querySelectorAll('button[data-trainer]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          overlayPick.classList.remove('open');
          setTrainer(btn.dataset.trainer);
        }, {once:true});
      });
    }
    let trainerId = (new URL(location.href)).searchParams.get('trainer') || '';
    function setTrainer(name){
      trainerId = name;
      const url = new URL(location.href);
      url.searchParams.set('trainer', trainerId);
      history.replaceState(null, '', url.toString());
      ctxEl.textContent = `Trainer: ${trainerId}`;
      boot();
    }
    if (trainerId) ctxEl.textContent = `Trainer: ${trainerId}`;

    /* ---------------- Day + setups tabs ---------------- */
    const dayPicker = document.getElementById('dayPicker');
    const todayBtn  = document.getElementById('todayBtn');
    dayPicker.value = ymd(new Date());
    todayBtn.addEventListener('click', ()=>{ dayPicker.value = ymd(new Date()); switchDay(dayPicker.value); });
    dayPicker.addEventListener('change', ()=>switchDay(dayPicker.value));
    const tabsEl = document.getElementById('tabs');
    let currentDateKey = dayPicker.value;
    let setupsMeta = [];
    let activeSetupId = null;

    /* ---------------- Dog / setup / scores state ---------------- */
    let dog = { id:null, name:null, profile:null, photo:null };
    let setupItemsMarks = [];
    let setupItemsBlinds = [];
    let scores = { marks:{}, blinds:{} };

    let unsubSetups = null;
    let unsubSetupDoc = null;
    let unsubScoreDoc = null;

    // Debounced save
    let saveTimer = null;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveNow, SAVE_DEBOUNCE_MS); }

    /* ---------------- Firestore paths ---------------- */
    const dayDocPath   = () => doc(db, "setups", trainerId, "days", currentDateKey);
    const setupsColl   = () => collection(dayDocPath(), "setups");
    const setupDocRef  = () => (activeSetupId ? doc(setupsColl(), activeSetupId) : null);

    // Kennel slot â†’ dog lookup
    const slotRef = doc(db, "trailerLayouts", `${trailerNorm}-${sexNorm}`, "slots", slotId);

    // Dog-centric runs
    const ratingsDayDoc = () => doc(db, "ratings", dog.id, "days", currentDateKey);
    const dogRunDoc     = () => doc(db, "ratings", dog.id, "days", currentDateKey, "setups", activeSetupId, "runs", "base");
    const mirrorRunDoc  = () => doc(db, "setups", trainerId, "days", currentDateKey, "setups", activeSetupId, "scores", dog.id, "runs", "base");

    /* ---------------- Dog hero rendering ---------------- */
    const dogCard = document.getElementById('dogCard');
    function renderDogCard(){
      dogCard.innerHTML = `
        <div class="hero">
          <img src="${dog.photo||''}" alt="">
          <div>
            <h2 style="margin:0 0 4px">${dog.name || 'Unassigned'}</h2>
            <div class="muted">Trailer: ${trailer||'â€”'} Â· Sex: ${sex||'â€”'} Â· Slot: ${slotNum||'â€”'}</div>
          </div>
        </div>
      `;
    }

    /* ---------------- Setup tabs ---------------- */
    function renderTabs(){
      tabsEl.innerHTML = '';
      setupsMeta.sort((a,b)=>(a.order??0)-(b.order??0)).forEach((m, idx)=>{
        const b = document.createElement('button');
        b.className = 'tab' + (m.id===activeSetupId ? ' active' : '');
        b.textContent = m.name || `Setup ${idx+1}`;
        b.addEventListener('click', ()=>setActiveSetup(m.id));
        tabsEl.appendChild(b);
      });
    }

    async function attachSetupsListener(){
      if (!trainerId) return;
      if (unsubSetups) { try{unsubSetups();}catch{} unsubSetups = null; }
      const qy = query(setupsColl(), orderBy('order'));
      unsubSetups = onSnapshot(qy, async (snap)=>{
        const arr = [];
        snap.forEach(d=>{
          const data = d.data()||{};
          arr.push({ id:d.id, name:data.name||'Setup', order: typeof data.order==='number'?data.order:9999 });
        });
        setupsMeta = arr;
        if (!activeSetupId && setupsMeta.length) activeSetupId = setupsMeta[0].id;
        renderTabs();
        attachSetupDocListener();
        attachScoresListener();
      });
    }

    function attachSetupDocListener(){
      if (!activeSetupId) return;
      if (unsubSetupDoc) { try{unsubSetupDoc();}catch{} unsubSetupDoc = null; }
      const ref = setupDocRef();
      unsubSetupDoc = onSnapshot(ref, (snap)=>{
        const data = snap.data()||{};
        setupItemsMarks  = Array.isArray(data.items)  ? data.items.map(it=>({ id: it.id, dist: typeof it.dist==='number' ? it.dist : 0 })) : [];
        setupItemsBlinds = Array.isArray(data.blinds) ? data.blinds.map(it=>({ id: it.id, dist: typeof it.dist==='number' ? it.dist : 0 })) : [];
        renderScoresUIFromCurrentItems();
      });
    }

    function attachScoresListener(){
      if (!dog.id || !activeSetupId) return;
      if (unsubScoreDoc) { try{unsubScoreDoc();}catch{} unsubScoreDoc = null; }
      unsubScoreDoc = onSnapshot(dogRunDoc(), (snap)=>{
        const data = snap.data() || {};
        const s = data.scores || {};
        if ('marks' in s || 'blinds' in s) scores = { marks: s.marks || {}, blinds: s.blinds || {} };
        else scores = { marks: s || {}, blinds:{} }; // legacy
        renderScoresUIFromCurrentItems();
      });
    }

    async function setActiveSetup(id){
      activeSetupId = id;
      renderTabs();
      attachSetupDocListener();
      attachScoresListener();
      const snap = await getDoc(dogRunDoc());
      const data = snap.exists() ? snap.data() : null;
      if (data && data.scores) {
        const s = data.scores;
        scores = ('marks' in s || 'blinds' in s) ? { marks: s.marks||{}, blinds:s.blinds||{} } : { marks:s||{}, blinds:{} };
      } else {
        scores = { marks:{}, blinds:{} };
      }
      renderScoresUIFromCurrentItems();
    }

    async function switchDay(key){
      currentDateKey = key;
      if (unsubSetups)    { try{unsubSetups();}catch{}    unsubSetups=null; }
      if (unsubSetupDoc)  { try{unsubSetupDoc();}catch{}  unsubSetupDoc=null; }
      if (unsubScoreDoc)  { try{unsubScoreDoc();}catch{}  unsubScoreDoc=null; }
      setupsMeta = [];
      activeSetupId = null;
      setupItemsMarks = [];
      setupItemsBlinds = [];
      scores = { marks:{}, blinds:{} };
      renderTabs();
      renderScoresUI([]);
      if (trainerId) attachSetupsListener();
    }

    /* ---------------- Dog & boot ---------------- */
    async function attachDogListener(){
      if (!trailer || !sex || !slotNum) {
        dogCard.textContent = "Missing trailer, sex, or slot in URL.";
        return;
      }
      onSnapshot(slotRef, async (snap)=>{
        let profileData = null;
        dog = { id:null, name:null, profile:null, photo:null };
        if (snap.exists()) {
          const data = snap.data();
          dog.name = data.dogName || null;
          if (dog.name) {
            dog.id = slug(dog.name);
            const pSnap = await getDoc( doc(db, "profiles", dog.id) );
            if (pSnap.exists()) {
              profileData = pSnap.data();
              dog.profile = profileData;
              dog.photo = profileData.photo || null;
            }
          }
        }
        renderDogCard();
        attachScoresListener(); // ensure we watch the right doc when dog appears
      });
    }

    /* ---------------- Scores UI ---------------- */
    const scoresTitle = document.getElementById('scoresTitle');
    const paneTabs = document.getElementById('paneTabs');
    let activePane = 'marks';
    paneTabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('.mini-tab'); if (!btn) return;
      const pane = btn.dataset.pane;
      if (pane && pane !== activePane) {
        activePane = pane;
        paneTabs.querySelectorAll('.mini-tab').forEach(b => b.classList.toggle('active', b.dataset.pane===activePane));
        renderScoresUIFromCurrentItems();
      }
    });

    const scoreList = document.getElementById('scoreList');

    function markLabel(item, idx){ return `#${idx+1} - ${Number(item.dist||0)} yards`; }
    function blindLabel(item, idx){ return `#${idx+1} - ${Number(item.dist||0)} yards`; }

    function renderScoresUI(items){
      scoreList.innerHTML = '';
      const paneName = activePane==='marks' ? 'Marks' : 'Blinds';
      const setupName = (setupsMeta.find(s=>s.id===activeSetupId)?.name)||'Setup';
      scoresTitle.textContent = `${paneName} (${setupName})`;

      const defs = activePane==='marks' ? FLAG_DEFS_MARKS : FLAG_DEFS_BLINDS;
      const bucket = activePane==='marks' ? (scores.marks ||= {}) : (scores.blinds ||= {});

      items.forEach((item, idx)=>{
        const card = document.createElement('div');
        card.className = 'score-card';

        const head = document.createElement('div');
        head.className = 'score-header';

        const title = document.createElement('div');
        title.className = 'score-title';
        title.textContent = activePane==='marks' ? markLabel(item, idx) : blindLabel(item, idx);

        const flagBtn = document.createElement('button');
        flagBtn.className = 'btn flag-btn';
        flagBtn.textContent = 'Flags';
        flagBtn.addEventListener('click', ()=> openRadialFor(item.id, defs, bucket));

        head.append(title, flagBtn);

        const sliderRow = document.createElement('div');
        sliderRow.className = 'slider-row';
        const slider = document.createElement('input');
        slider.type = 'range'; slider.min='0'; slider.max='10'; slider.step='0.5';
        const cur = bucket[item.id]?.score ?? 0;
        slider.value = String(cur);
        const out = document.createElement('div');
        out.className = 'slider-val';
        out.textContent = Number(cur).toFixed(1);
        slider.addEventListener('input', ()=>{
          const val = Number(slider.value);
          out.textContent = val.toFixed(1);
          (bucket[item.id] ||= { score:0, flags:{} }).score = val;
          scheduleSave();
        });
        sliderRow.append(slider, out);

        card.append(head, sliderRow);
        scoreList.appendChild(card);
      });
    }
    function renderScoresUIFromCurrentItems(){
      const items = activePane==='marks' ? setupItemsMarks : setupItemsBlinds;
      renderScoresUI(items);
    }

    /* ---------------- Save ---------------- */
    const saveStatus = document.getElementById('saveStatus');
    document.getElementById('saveOnlyBtn').addEventListener('click', async ()=>{
      const b = document.getElementById('saveOnlyBtn'); b.disabled = true;
      try { await saveNow(); } finally { b.disabled = false; }
    });
    document.getElementById('saveCameraBtn').addEventListener('click', async ()=>{
      await saveNow();
      location.href = "https://morrowind4732.github.io/task-tracker/Camera.html";
    });

    async function saveNow(){
      if (!dog.id || !activeSetupId) return;
      saveStatus.textContent = 'Savingâ€¦';
      const setupName = (setupsMeta.find(s=>s.id===activeSetupId)?.name) || null;
      const payload = {
        scores,
        trainer: trainerId, setupId: activeSetupId, setupName,
        dogId: dog.id, dogName: dog.name || null,
        runId: 'base',
        dateKey: currentDateKey,
        trailer: trailer, sex: sex, slotId,
        updatedAt: serverTimestamp()
      };
      try {
        await Promise.all([
          setDoc(dogRunDoc(), payload, { merge:true }),
          setDoc(mirrorRunDoc(), payload, { merge:true }),
          setDoc(ratingsDayDoc(), { date: currentDateKey, trailer, sex, slotId, lastScoredAt: serverTimestamp(), trainer: trainerId }, { merge:true })
        ]);
        saveStatus.textContent = 'Saved.';
        setTimeout(()=>saveStatus.textContent='', 900);
      } catch (e) {
        console.error(e);
        saveStatus.textContent = 'Save failed.';
      }
    }

    /* ---------------- Radial menu (CROSS layout) ---------------- */
    const radial = document.getElementById('radialOverlay');
    const wheelEl = document.getElementById('wheel');
    const wheelTitle = document.getElementById('wheelTitle');
    const centerCancel = document.getElementById('centerCancel');

    let currentRadial = { id:null, defs:null, bucket:null };

    function openRadialFor(itemId, defs, bucket){
      currentRadial = { id:itemId, defs, bucket };
      wheelTitle.textContent = `${activePane==='marks'?'Marks':'Blinds'} â€” Flags`;

      // clear old buttons
      [...wheelEl.querySelectorAll('.rad-btn')].forEach(n => n.remove());

      // build position buckets: top(4), bottom(4), left(1), right(1)
      const top    = defs.slice(0,4);
      const bottom = defs.slice(4,8);
      const left   = defs[8] ? [defs[8]] : [];
      const right  = defs[9] ? [defs[9]] : [];

      const created = {
        top: top.map(makeBtn),
        bottom: bottom.map(makeBtn),
        left: left.map(makeBtn),
        right: right.map(makeBtn)
      };

      // position after inserted (so widths are known)
      requestAnimationFrame(()=>{
        created.top.forEach((b,i)=> placeButton(b, 'top', i));
        created.bottom.forEach((b,i)=> placeButton(b, 'bottom', i));
        created.left.forEach((b)=> placeButton(b, 'left'));
        created.right.forEach((b)=> placeButton(b, 'right'));
      });

      radial.classList.add('open');
      radial.setAttribute('aria-hidden','false');

      function makeBtn(fd){
        const b = document.createElement('button');
        b.className = 'rad-btn';
        b.textContent = fd.label;
        const isOn = !!(bucket[itemId]?.flags?.[fd.key]);
        if (isOn) b.classList.add('active');
        b.addEventListener('click', ()=>{
          (bucket[itemId] ||= { score:0, flags:{} });
          bucket[itemId].flags[fd.key] = !bucket[itemId].flags[fd.key];
          b.classList.toggle('active', !!bucket[itemId].flags[fd.key]);
          scheduleSave();
        });
        wheelEl.appendChild(b);
        return b;
      }
    }

    // CROSS layout: 4 stack up at 12, 4 stack down at 6, 1 left, 1 right (pushed out)
    function placeButton(el, spot, index = 0) {
      const W = wheelEl.clientWidth, H = wheelEl.clientHeight;
      const cx = W / 2, cy = H / 2;

      const VSPACE = 8;     // vertical gap between stacked buttons
      const R_TOP = 86;     // distance to first top button (closest to center)
      const R_BOTTOM = 86;  // distance to first bottom button
      const R_SIDE = 160;   // push side buttons outward to avoid overlap

      const w = el.offsetWidth, h = el.offsetHeight;

      if (spot === 'left') {
        el.style.left = (cx - R_SIDE - w) + 'px';
        el.style.top  = (cy - h / 2) + 'px';
      } else if (spot === 'right') {
        el.style.left = (cx + R_SIDE) + 'px';
        el.style.top  = (cy - h / 2) + 'px';
      } else if (spot === 'top') {
        const baseY = cy - R_TOP - h/2; // first at 12 o'clock
        el.style.left = (cx - w/2) + 'px';
        el.style.top  = (baseY - index * (h + VSPACE)) + 'px'; // stack upward
      } else if (spot === 'bottom') {
        const baseY = cy + R_BOTTOM - h/2; // first at 6 o'clock
        el.style.left = (cx - w/2) + 'px';
        el.style.top  = (baseY + index * (h + VSPACE)) + 'px'; // stack downward
      }
    }

    centerCancel.addEventListener('click', closeRadial);
    radial.addEventListener('click', (e)=>{ if (e.target === radial) closeRadial(); });
    function closeRadial(){
      radial.classList.remove('open');
      radial.setAttribute('aria-hidden','true');
    }

    /* ---------------- Boot ---------------- */
    async function boot(){
      if (!trainerId) return showTrainerPrompt();
      ctxEl.textContent = `Trainer: ${trainerId}`;
      await switchDay(ymd(new Date()));
      await attachDogListener();
      if (trainerId) attachSetupsListener();
    }

    if (trainerId) boot(); else showTrainerPrompt();
  </script>
</body>
</html>
