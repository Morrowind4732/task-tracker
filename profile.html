<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scoring V2 â€“ Radial (Like Setups)</title>

<style>
  :root { --gap:12px; --border:#ddd; --accent:#0b74ff; }
  body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; }
  .title-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .mini-link { font-size:12px; color:var(--accent); text-decoration:underline; }
  .mini-link:visited { color:var(--accent); }
  .muted { color:#666; font-size:12px; }
  .btn { appearance:none; border:1px solid #bbb; background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  .btn.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
  .btn.ghost { background:#fff; border-color:#ccc; }

  .section { border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:14px; background:#fff; }

  /* Tabs / day */
  .tabs-bar { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .tabs { display:flex; align-items:flex-end; gap:6px; flex-wrap:wrap; }
  .tab { padding:8px 12px; border:1px solid var(--border); border-bottom:none; border-top-left-radius:10px; border-top-right-radius:10px; background:#f6f6f6; cursor:pointer; font-weight:600; color:#444; }
  .tab.active { background:#fff; color:#111; box-shadow:0 -1px 0 #fff inset; }
  .tab:hover { background:#fdfdfd; }

  /* Mini pane tabs */
  .mini-tabs { display:flex; gap:6px; align-items:center; }
  .mini-tab { padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f7f7f7; font-weight:600; cursor:pointer; }
  .mini-tab.active { background:#fff; border-color:#bbb; }

  /* Score cards */
  .score-list { display:flex; flex-direction:column; gap:12px; }
  .score-card {
    border:1px solid #e2e2e2; border-radius:10px; padding:10px; background:#fafafa;
    display:grid; gap:8px; grid-template-columns: 1fr;
  }
  .score-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .score-title { font-weight:700; }
  .score-tools { display:flex; gap:8px; align-items:center; }
  .slider-row { display:flex; align-items:center; gap:10px; }
  .slider-row input[type="range"] { flex:1; }
  .slider-val { width:48px; text-align:right; font-variant-numeric: tabular-nums; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  /* ---------- Radial overlay (like setups wheel) ---------- */
  .r-overlay { position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:center; justify-content:center; z-index:9999; }
  .r-overlay.open { display:flex; }
  .r-wheel {
    position: relative;
    width: 300px; height: 300px;
    border-radius: 50%;
    background:#fff;
    border:1px solid var(--border);
    box-shadow:0 12px 30px rgba(0,0,0,.25);
  }
  .r-center {
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    width: 120px; height:120px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    text-align:center; padding:10px;
    background:#fafafa; border:2px solid #eee; font-weight:700;
    cursor:pointer;
  }
  .r-item {
    position:absolute; width:auto; max-width:120px;
    border-radius:999px; padding:6px 10px;
    border:1px solid #ddd; background:#fff; font-size:12px;
    text-align:center; white-space:nowrap;
    box-shadow:0 6px 14px rgba(0,0,0,.10);
    cursor:pointer;
  }
  .r-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  .r-caption {
    position:absolute; left:50%; top:10px; transform:translateX(-50%);
    font-weight:700; font-size:14px;
  }

  /* Small gear */
  .gear { padding:6px 8px; border-radius:8px; }
</style>
</head>
<body>
  <div class="title-row">
    <h1 style="margin:0">Scoring V2 (Radial)</h1>
    <a id="changeUserLink" class="mini-link" href="#">change user</a>
  </div>
  <div class="muted" id="ctx">Loadingâ€¦</div>

  <!-- Tabs / day -->
  <div class="section">
    <div class="tabs-bar">
      <div style="margin-right:auto; display:flex; gap:8px; align-items:center;">
        <label>Day: <input type="date" id="dayPicker"></label>
        <button class="btn ghost" id="todayBtn">Today</button>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </div>

  <!-- Scores -->
  <div class="section" id="scoresSection">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
      <strong id="scoresTitle">â€”</strong>
      <div class="mini-tabs" id="paneTabs">
        <button class="mini-tab active" data-pane="marks">Marks</button>
        <button class="mini-tab" data-pane="blinds">Blinds</button>
      </div>
    </div>

    <div class="score-list" id="scoreList"></div>

    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="saveCameraBtn">ðŸ’¾ Save & Camera</button>
      <a class="btn" id="cameraOnlyBtn" href="https://morrowind4732.github.io/task-tracker/Camera.html">ðŸ“· Camera (no save)</a>
      <button class="btn" id="saveOnlyBtn">ðŸ’¾ Save</button>
      <span class="muted" id="saveStatus"></span>
    </div>
  </div>

  <!-- Radial overlay (shared for all items) -->
  <div id="radialOverlay" class="r-overlay" aria-hidden="true">
    <div class="r-wheel">
      <div class="r-caption" id="rCaption">Flags</div>
      <button class="r-center" id="rCancel" type="button">Cancel</button>
      <!-- buttons injected here -->
    </div>
  </div>

  <!-- Firebase (v10 modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp,
      collection, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    /* ---------------- Firebase init ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.firebasestorage.app",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------------- Utilities ---------------- */
    const ctxEl = document.getElementById('ctx');
    function ymd(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
    function slug(s){
      return String(s||"").toLowerCase().trim()
        .replace(/[\s_]+/g,'-').replace(/[^a-z0-9-]/g,'')
        .replace(/-{2,}/g,'-').replace(/^-+|-+$/g,'');
    }
    const SAVE_DEBOUNCE_MS = 300;
    let saveTimer = null;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveNow, SAVE_DEBOUNCE_MS); }

    /* ---------------- Flags + layout mapping ---------------- */
    const FLAG_DEFS_MARKS = [
      { key:'headswing',       label:'Headswing' },
      { key:'shortCheckDown',  label:'Short Check Down' },
      { key:'overran',         label:'Overran' },
      { key:'bigHunt',         label:'Big Hunt' },
      { key:'handled',         label:'Handled' },
      { key:'castRefusal',     label:'Cast Refusal' },
      { key:'sitOnWhistle',    label:'Sit On Whistle' },
      { key:'backSideOfGun',   label:'Back Side of Gun' },
      { key:'break',           label:'Break' },
      { key:'skipped',         label:'Skipped' },
    ];
    const FLAG_DEFS_BLINDS = [
      { key:'poorInitial',     label:'Poor Initial' },
      { key:'scallop',         label:'Scallop' },
      { key:'castRefusal',     label:'Cast Refusal' },
      { key:'pickedUpPoison',  label:'Picked Up Poison' },
      { key:'hunted',          label:'Hunted' },
      { key:'ignoredWhistle',  label:'Ignored Whistle' },
      { key:'failedDiversion', label:'Failed Diversion' },
      { key:'skipped',         label:'Skipped' },
    ];

    // Place 10 â€œsurroundâ€ positions like your setups wheel:
    // top arc (4), left, right, bottom arc (4). Center is Cancel.
    const POS10 = [
      {dx:-100, dy:-110}, {dx:-40, dy:-120}, {dx: 40, dy:-120}, {dx:100, dy:-110}, // top 4
      {dx:-140, dy:  0}, {dx: 140, dy:  0},                                        // left / right
      {dx:-100, dy: 110}, {dx:-40, dy: 120}, {dx: 40, dy: 120}, {dx:100, dy: 110}, // bottom 4
    ];

    // Short labels on the pills; full label is hover title
    const SHORT = {
      headswing:'HS', shortCheckDown:'SCD', overran:'OR', bigHunt:'BH',
      handled:'HND', castRefusal:'CR', sitOnWhistle:'SOW', backSideOfGun:'BSG',
      break:'BRK', skipped:'SKP',
      poorInitial:'PI', scallop:'SCL', pickedUpPoison:'PUP', hunted:'HNT',
      ignoredWhistle:'IW', failedDiversion:'FD'
    };

    const MARKS_LAYOUT = [
      'headswing','shortCheckDown','overran','bigHunt', // top 4
      'break','skipped',                                // left/right
      'handled','castRefusal','sitOnWhistle','backSideOfGun' // bottom 4
    ];
    const BLINDS_LAYOUT = [
      'poorInitial','scallop','castRefusal','pickedUpPoison', // top 4
      null, null,                                             // left/right hidden for 8 total
      'hunted','ignoredWhistle','failedDiversion','skipped'   // bottom 4
    ];

    /* ---------------- URL params ---------------- */
    const params  = new URL(location.href).searchParams;
    const trailer = (params.get('trailer')||'').trim();
    const sex     = (params.get('sex')||'').trim();
    const slotNum = (params.get('slot')||'').trim();
    let   trainerId = (params.get('trainer')||'').trim();

    const trailerNorm = trailer.toLowerCase();
    const sexNorm     = sex.toLowerCase();

    // Change user link (just clears ?trainer=)
    document.getElementById('changeUserLink').addEventListener('click', (e)=>{
      e.preventDefault();
      const url = new URL(location.href);
      url.searchParams.delete('trainer');
      history.replaceState(null, '', url.toString());
      trainerId = '';
      ctxEl.textContent = 'Trainer not set (add ?trainer=NAME in URL).';
    });

    if (!trailer || !sex || !slotNum) {
      document.getElementById('scoresSection').innerHTML = '<div class="muted">Missing trailer, sex, or slot in URL.</div>';
      throw new Error('Missing QR params');
    }
    ctxEl.textContent = trainerId ? `Trainer: ${trainerId}` : 'Trainer not set';

    /* ---------------- Day + setups ---------------- */
    const dayPicker = document.getElementById('dayPicker');
    const todayBtn  = document.getElementById('todayBtn');
    dayPicker.value = ymd(new Date());
    todayBtn.addEventListener('click', ()=>{ dayPicker.value = ymd(new Date()); switchDay(dayPicker.value); });
    dayPicker.addEventListener('change', ()=>switchDay(dayPicker.value));

    const tabsEl = document.getElementById('tabs');
    let currentDateKey = dayPicker.value;
    let setupsMeta = [];       // [{id,name,order}]
    let activeSetupId = null;  // setup doc id
    let activePane = 'marks';  // marks | blinds

    // current dog from slot
    const trailerPrefix = trailerNorm.charAt(0).toUpperCase();
    const sexPrefix     = sexNorm.charAt(0).toUpperCase();
    const slotId        = `${trailerPrefix}_${sexPrefix}_${slotNum}`;
    const slotRef       = doc(db, "trailerLayouts", `${trailerNorm}-${sexNorm}`, "slots", slotId);
    let dog = { id:null, name:null };

    // Firestore paths
    const dayDocPath = () => doc(db, "setups", trainerId, "days", currentDateKey);
    const setupsColl = () => collection(dayDocPath(), "setups");
    const setupDoc   = () => (activeSetupId ? doc(setupsColl(), activeSetupId) : null);

    // Scores documents
    const ratingsDayDoc = () => doc(db, "ratings", dog.id, "days", currentDateKey);
    const dogRunDoc     = () => doc(db, "ratings", dog.id, "days", currentDateKey, "setups", activeSetupId, "runs", "base");
    const mirrorRunDoc  = () => doc(db, "setups", trainerId, "days", currentDateKey, "setups", activeSetupId, "scores", dog.id, "runs", "base");

    // UI refs
    const paneTabs = document.getElementById('paneTabs');
    const scoreList = document.getElementById('scoreList');
    const scoresTitle = document.getElementById('scoresTitle');
    const saveStatus = document.getElementById('saveStatus');

    // state
    let setupItemsMarks = [];
    let setupItemsBlinds = [];
    let scores = { marks:{}, blinds:{} };

    /* ---------------- Tabs / panes ---------------- */
    function renderTabs(){
      tabsEl.innerHTML = '';
      setupsMeta.sort((a,b)=>(a.order??0)-(b.order??0)).forEach((m, idx)=>{
        const b = document.createElement('button');
        b.className = 'tab' + (m.id===activeSetupId ? ' active' : '');
        b.textContent = m.name || `Setup ${idx+1}`;
        b.addEventListener('click', ()=>setActiveSetup(m.id));
        tabsEl.appendChild(b);
      });
    }
    paneTabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('.mini-tab'); if (!btn) return;
      const pane = btn.dataset.pane;
      if (pane && pane !== activePane) {
        activePane = pane;
        paneTabs.querySelectorAll('.mini-tab').forEach(b => b.classList.toggle('active', b.dataset.pane===activePane));
        renderScoresUIFromCurrentItems();
      }
    });

    /* ---------------- Cards + radial wheel ---------------- */
    function markLabel(item, idx){
      const n = (idx+1);
      const dist = typeof item.dist==='number' ? item.dist : 0;
      return `Mark #${n} â€¢ ${dist}y`;
    }
    function blindLabel(item, idx){
      const n = (idx+1);
      const dist = typeof item.dist==='number' ? item.dist : 0;
      return `Blind #${n} â€¢ ${dist}y`;
    }

    // Shared overlay
    const rOverlay = document.getElementById('radialOverlay');
    const rWheel   = rOverlay.querySelector('.r-wheel');
    const rCancel  = document.getElementById('rCancel');
    const rCaption = document.getElementById('rCaption');

    let currentWheelCtx = null; // { pane, itemId, flags, layout, defs }

    function closeWheel(){ rOverlay.classList.remove('open'); rOverlay.setAttribute('aria-hidden','true'); rWheel.querySelectorAll('.r-item').forEach(n=>n.remove()); currentWheelCtx=null; }
    rCancel.addEventListener('click', closeWheel);
    rOverlay.addEventListener('click', (e)=>{ if (e.target === rOverlay) closeWheel(); });

    function openWheel({ title, pane, itemId, flags, layout, defs }){
      // Clean last
      rWheel.querySelectorAll('.r-item').forEach(n=>n.remove());
      currentWheelCtx = { pane, itemId, flags, layout, defs };
      rCaption.textContent = title || 'Flags';
      // Build items
      for (let i=0;i<POS10.length;i++){
        const key = layout[i];
        if (!key) continue; // hidden slot (e.g., blinds left/right)
        const def = defs.find(d=>d.key===key);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'r-item';
        btn.textContent = SHORT[key] || def?.label || key;
        btn.title = def?.label || key;
        const {dx,dy} = POS10[i];
        btn.style.left = '50%';
        btn.style.top  = '50%';
        btn.style.transform = `translate(-50%,-50%) translate(${dx}px, ${dy}px)`;
        if (flags[key]) btn.classList.add('active');
        btn.addEventListener('click', ()=>{
          const newVal = !flags[key];
          flags[key] = newVal;
          btn.classList.toggle('active', newVal);
          // persist to state and debounce save
          const bucket = pane==='marks' ? (scores.marks ||= {}) : (scores.blinds ||= {});
          (bucket[itemId] ||= { score:0, flags:{} });
          bucket[itemId].flags[key] = newVal;
          scheduleSave();
        });
        rWheel.appendChild(btn);
      }
      // Open
      rOverlay.classList.add('open');
      rOverlay.setAttribute('aria-hidden','false');
    }

    function renderScoresUI(items){
      scoreList.innerHTML = '';
      const paneName = activePane==='marks' ? 'Marks' : 'Blinds';
      const setupName = (setupsMeta.find(s=>s.id===activeSetupId)?.name)||'Setup';
      scoresTitle.textContent = `${paneName} â€¢ ${setupName}`;

      const bucket = activePane==='marks' ? (scores.marks ||= {}) : (scores.blinds ||= {});
      const layout = activePane==='marks' ? MARKS_LAYOUT : BLINDS_LAYOUT;
      const defs   = activePane==='marks' ? FLAG_DEFS_MARKS : FLAG_DEFS_BLINDS;

      items.forEach((item, idx)=>{
        const card = document.createElement('div');
        card.className = 'score-card';

        const head = document.createElement('div');
        head.className = 'score-header';
        const title = document.createElement('div');
        title.className = 'score-title';
        title.textContent = activePane==='marks' ? markLabel(item, idx) : blindLabel(item, idx);

        const tools = document.createElement('div');
        tools.className = 'score-tools';
        const gear = document.createElement('button');
        gear.className = 'btn gear';
        gear.type = 'button';
        gear.textContent = 'âš™ Flags';
        gear.addEventListener('click', ()=>{
          const flagsState = (bucket[item.id]?.flags) || {};
          openWheel({
            title: title.textContent,
            pane: activePane,
            itemId: item.id,
            flags: flagsState,
            layout,
            defs
          });
        });
        tools.appendChild(gear);

        const sliderRow = document.createElement('div');
        sliderRow.className = 'slider-row';
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = '0'; slider.max = '10'; slider.step = '0.5';
        const cur = bucket[item.id]?.score ?? 0;
        slider.value = String(cur);
        const out = document.createElement('div');
        out.className = 'slider-val';
        out.textContent = Number(cur).toFixed(1);
        slider.addEventListener('input', ()=>{
          const val = Number(slider.value);
          out.textContent = val.toFixed(1);
          (bucket[item.id] ||= { score:0, flags:{} }).score = val;
          scheduleSave();
        });
        sliderRow.append(slider, out);

        head.append(title, tools);
        card.append(head, sliderRow);
        scoreList.appendChild(card);
      });
    }
    function renderScoresUIFromCurrentItems(){
      const items = activePane==='marks' ? setupItemsMarks : setupItemsBlinds;
      renderScoresUI(items);
    }

    /* ---------------- Saving ---------------- */
    async function saveNow(){
      if (!dog.id || !activeSetupId || !trainerId) return;
      saveStatus.textContent = 'Savingâ€¦';
      const setupName = (setupsMeta.find(s=>s.id===activeSetupId)?.name) || null;
      const payload = {
        scores,
        trainer: trainerId, setupId: activeSetupId, setupName,
        dogId: dog.id, dogName: dog.name || null,
        runId: 'base',
        dateKey: currentDateKey,
        trailer, sex, slotId,
        updatedAt: serverTimestamp()
      };
      try {
        await Promise.all([
          setDoc(dogRunDoc(), payload, { merge:true }),
          setDoc(mirrorRunDoc(), payload, { merge:true }),
          setDoc(ratingsDayDoc(), { date: currentDateKey, trailer, sex, slotId, lastScoredAt: serverTimestamp(), trainer: trainerId }, { merge:true })
        ]);
        saveStatus.textContent = 'Saved.';
        setTimeout(()=>saveStatus.textContent='', 800);
      } catch (e) {
        console.error(e);
        saveStatus.textContent = 'Save failed.';
      }
    }
    document.getElementById('saveOnlyBtn').addEventListener('click', async ()=>{
      const b = document.getElementById('saveOnlyBtn'); b.disabled = true;
      try { await saveNow(); } finally { b.disabled = false; }
    });
    document.getElementById('saveCameraBtn').addEventListener('click', async ()=>{
      await saveNow();
      location.href = "https://morrowind4732.github.io/task-tracker/Camera.html";
    });

    /* ---------------- Listeners: dog + setups + run ---------------- */
    onSnapshot(slotRef, async (snap)=>{
      dog = { id:null, name:null };
      if (snap.exists()) {
        const data = snap.data() || {};
        dog.name = data.dogName || null;
        if (dog.name) dog.id = slug(dog.name);
      }
      if (trainerId) attachSetupsListener();
    });

    let unsubSetups=null, unsubSetupDoc=null, unsubScores=null;

    async function attachSetupsListener(){
      if (!trainerId) return;
      if (unsubSetups) { try{unsubSetups();}catch{} unsubSetups=null; }
      const qy = query(setupsColl(), orderBy('order'));
      unsubSetups = onSnapshot(qy, async (snap)=>{
        const arr = [];
        snap.forEach(d=>{
          const data = d.data()||{};
          arr.push({ id:d.id, name:data.name||'Setup', order: typeof data.order==='number'?data.order:9999 });
        });
        setupsMeta = arr;
        if (!activeSetupId && setupsMeta.length) activeSetupId = setupsMeta[0].id;
        renderTabs();
        attachSetupDocListener();
        attachScoresListener();
      });
    }

    function attachSetupDocListener(){
      if (!activeSetupId) return;
      if (unsubSetupDoc) { try{unsubSetupDoc();}catch{} unsubSetupDoc=null; }
      unsubSetupDoc = onSnapshot(setupDoc(), (snap)=>{
        const data = snap.data()||{};
        setupItemsMarks  = Array.isArray(data.items)  ? data.items.map(it=>({ id: it.id, dist: typeof it.dist==='number' ? it.dist : 0 })) : [];
        setupItemsBlinds = Array.isArray(data.blinds) ? data.blinds.map(it=>({ id: it.id, dist: typeof it.dist==='number' ? it.dist : 0 })) : [];
        renderScoresUIFromCurrentItems();
      });
    }

    function normalizeScoresShape(data){
      let out = { marks:{}, blinds:{} };
      if (data && data.scores) {
        const s = data.scores;
        if ('marks' in s || 'blinds' in s) {
          out.marks  = s.marks  || {};
          out.blinds = s.blinds || {};
        } else {
          out.marks = s || {};
          out.blinds = {};
        }
      }
      return out;
    }

    function attachScoresListener(){
      if (unsubScores) { try{unsubScores();}catch{} unsubScores=null; }
      if (!dog.id || !activeSetupId) return;
      unsubScores = onSnapshot(dogRunDoc(), (snap)=>{
        scores = normalizeScoresShape(snap.data());
        renderScoresUIFromCurrentItems();
      });
    }

    async function setActiveSetup(id){
      activeSetupId = id;
      renderTabs();
      attachSetupDocListener();
      attachScoresListener();
      const snap = await getDoc(dogRunDoc());
      scores = normalizeScoresShape(snap.exists() ? snap.data() : null);
      renderScoresUIFromCurrentItems();
    }

    async function switchDay(key){
      currentDateKey = key;
      if (unsubSetups) { try{unsubSetups();}catch{} unsubSetups=null; }
      if (unsubSetupDoc) { try{unsubSetupDoc();}catch{} unsubSetupDoc=null; }
      if (unsubScores) { try{unsubScores();}catch{} unsubScores=null; }

      setupsMeta = [];
      activeSetupId = null;
      scores = { marks:{}, blinds:{} };
      renderTabs();
      scoreList.innerHTML = '';
      if (trainerId) attachSetupsListener();
    }

    /* ---------------- Boot ---------------- */
    (function boot(){
      ctxEl.textContent = trainerId ? `Trainer: ${trainerId}` : 'Trainer not set';
      switchDay(ymd(new Date()));
    })();
  </script>
</body>
</html>
