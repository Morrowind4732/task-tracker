<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kennel</title>

<style>
  body { font-family: system-ui, sans-serif; margin: 16px; }
  .card { max-width: 820px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
  .hero { display: grid; grid-template-columns: 160px 1fr; gap: 16px; align-items: center; }
  .hero img { width:160px; height:160px; object-fit:cover; border-radius:12px; border:1px solid #ccc; }
  .badges { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .badge { padding:4px 8px; border:1px solid #bbb; border-radius:999px; font-size:12px; }
  .section { margin-top: 16px; }
  .section h3 { margin: 0 0 8px; }
  .ratings { display:grid; grid-template-columns: 1fr; gap:12px; }
  .rating-row { display:flex; align-items:center; gap:12px; }
  .label { width: 110px; font-weight: 600; }
  .stars { display:inline-flex; gap:8px; }
  .star {
    font-size: 34px;           /* bigger, thumb-friendly */
    line-height: 1;
    cursor: pointer;
    user-select: none;
    padding: 6px;              /* bigger tap target */
    border-radius: 8px;
  }
  .star.filled { color: #f39c12; }
  .star:active { transform: scale(0.96); }
  textarea { width: 100%; min-height: 96px; box-sizing: border-box; padding: 10px; font-size: 16px; border:1px solid #bbb; border-radius:8px; }
  .actions { display:flex; gap:10px; margin-top:12px; }
  .btn {
    appearance: none; border:1px solid #bbb; background:#fff;
    padding:10px 14px; border-radius:10px; font-size:16px; cursor:pointer;
  }
  .btn.primary { background:#0b74ff; color:#fff; border-color:#0b74ff; }
  .muted { color:#666; font-size:12px; margin-top:8px; }
</style>

<div class="card" id="card">Loadingâ€¦</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, getDoc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // --- Firebase config (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
    authDomain: "task-tracker-73b77.firebaseapp.com",
    projectId: "task-tracker-73b77",
    storageBucket: "task-tracker-73b77.firebasestorage.app",
    messagingSenderId: "795274673000",
    appId: "1:795274673000:web:0ea07130e45c72384134dd",
    measurementId: "G-VLW5KLY4FF"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // --- URL params (QR) ---
  const params  = new URL(location.href).searchParams;
  const trailer = params.get('trailer');   // e.g. 'scott'
  const slotId  = params.get('slot');      // e.g. 'S_M_R1C1'
  const cardEl  = document.getElementById('card');

  if (!trailer || !slotId) {
    cardEl.textContent = "Missing trailer or slot in URL.";
    throw new Error("Missing params");
  }

  // Helpers
  const CAMERA_URL = "https://morrowind4732.github.io/task-tracker/Camera.html";
  function nameToId(name){
    return String(name||"").toLowerCase().trim()
      .replace(/[\s_]+/g, '-').replace(/[^a-z0-9-]/g, '')
      .replace(/-{2,}/g, '-').replace(/^-+|-+$/g, '');
  }
  function todayLocalYYYYMMDD() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  // UI state for ratings
  const ratingState = { marks: 0, blinds: 0, behavior: 0, notes: "" };
  let currentDog = { id: null, name: null };

  function renderStars(name, current) {
    // name in {marks|blinds|behavior}
    let html = `<div class="rating-row">
      <div class="label">${name[0].toUpperCase()+name.slice(1)}</div>
      <div class="stars" data-field="${name}">`;
    for (let i=1; i<=5; i++) {
      const filled = i <= current ? 'filled' : '';
      html += `<span class="star ${filled}" data-value="${i}" aria-label="${name} ${i} of 5">â˜…</span>`;
    }
    html += `</div></div>`;
    return html;
  }

  function attachStarHandlers() {
    document.querySelectorAll('.stars').forEach(starRow => {
      starRow.addEventListener('click', e => {
        const star = e.target.closest('.star');
        if (!star) return;
        const value = Number(star.dataset.value);
        const field = starRow.dataset.field;
        ratingState[field] = value;
        // Repaint stars in this row
        starRow.querySelectorAll('.star').forEach(s => {
          s.classList.toggle('filled', Number(s.dataset.value) <= value);
        });
      }, { passive: true });
    });
  }

  function renderProfileCard(profile, trailer, slotId) {
    const p = profile || {};
    document.title = p.name ? `${p.name} â€“ ${slotId}` : `Kennel ${slotId}`;
    cardEl.innerHTML = `
      <div class="hero">
        <img src="${p.photo||''}" alt="">
        <div>
          <h1 style="margin:0 0 4px">${p.name || (currentDog.name || 'Unassigned')}</h1>
          <div>${[p.breed,(p.age!=null?`${p.age} yrs`:null)].filter(Boolean).join(' Â· ')}</div>
          <div class="badges">${(p.tags||[]).map(t=>`<span class="badge">${t}</span>`).join('')}</div>
          <div class="muted">Trailer: ${trailer} Â· Slot: ${slotId}</div>
        </div>
      </div>

      <div class="section">
        <h3>Ratings (today)</h3>
        <div class="ratings">
          ${renderStars('marks',    ratingState.marks)}
          ${renderStars('blinds',   ratingState.blinds)}
          ${renderStars('behavior', ratingState.behavior)}
        </div>
      </div>

      <div class="section">
        <h3>Notes</h3>
        <textarea id="notesBox" placeholder="Additional comments about todayâ€™s performance..."></textarea>
      </div>

      <div class="actions">
        <button class="btn primary" id="saveBtn">ðŸ’¾ Save & Camera</button>
        <a class="btn" id="cameraBtn" href="${CAMERA_URL}">ðŸ“· Camera (no save)</a>
      </div>
      <div class="muted" id="saveStatus"></div>
    `;
    attachStarHandlers();
    // Hook notes
    const notesBox = document.getElementById('notesBox');
    notesBox.value = ratingState.notes || '';
    notesBox.addEventListener('input', () => ratingState.notes = notesBox.value);
    // Buttons
    document.getElementById('saveBtn').onclick = saveAndGoCamera;
  }

  async function loadTodayIfExists() {
    if (!currentDog.id) return;
    const date = todayLocalYYYYMMDD();
    const ref = doc(db, "ratings", currentDog.id, "days", date);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const r = snap.data();
      ratingState.marks    = Number(r.marks || 0);
      ratingState.blinds   = Number(r.blinds || 0);
      ratingState.behavior = Number(r.behavior || 0);
      ratingState.notes    = String(r.notes || "");
    } else {
      ratingState.marks = ratingState.blinds = ratingState.behavior = 0;
      ratingState.notes = "";
    }
  }

  async function saveAndGoCamera() {
    if (!currentDog.id) {
      // derive from name if missing
      currentDog.id = nameToId(currentDog.name || "");
    }
    const status = document.getElementById('saveStatus');
    status.textContent = "Savingâ€¦";

    const date = todayLocalYYYYMMDD();
    const ref  = doc(db, "ratings", currentDog.id, "days", date);
    const payload = {
      dogId: currentDog.id,
      dogName: currentDog.name || null,
      trailer, slotId, date,
      marks: ratingState.marks || 0,
      blinds: ratingState.blinds || 0,
      behavior: ratingState.behavior || 0,
      notes: ratingState.notes || "",
      updatedAt: serverTimestamp()
    };
    try {
      await setDoc(ref, payload, { merge: true });
      // small delay so the UI can paint "Saved"
      status.textContent = "Saved. Redirecting to cameraâ€¦";
      setTimeout(() => location.href = CAMERA_URL, 120);
    } catch (e) {
      console.error(e);
      status.textContent = "Failed to save. Check connection and try again.";
    }
  }

  // --- Resolve dog from QR slot, then render ---
  const slotRef = doc(db, "trailerLayouts", trailer, "slots", slotId);
  onSnapshot(slotRef, async (snap) => {
    let profileData = null;
    if (!snap.exists()) {
      currentDog = { id: null, name: null };
    } else {
      const data = snap.data();
      currentDog.name = data.dogName || null;
      currentDog.id   = data.dogId || (data.dogName ? nameToId(data.dogName) : null);

      // If we have a profile doc, load it for the header card
      if (currentDog.id) {
        const profSnap = await getDoc(doc(db, "profiles", currentDog.id));
        if (profSnap.exists()) profileData = profSnap.data();
      }
    }
    await loadTodayIfExists();      // prefill todayâ€™s values if present
    renderProfileCard(profileData, trailer, slotId);
    // Repaint stars to reflect any loaded values
    document.querySelectorAll('.stars').forEach(row => {
      const field = row.dataset.field;
      const val = Number(ratingState[field] || 0);
      row.querySelectorAll('.star').forEach(s => {
        s.classList.toggle('filled', Number(s.dataset.value) <= val);
      });
    });
  }, (err) => {
    cardEl.textContent = `Error loading slot: ${err.message}`;
    console.error(err);
  });
</script>
