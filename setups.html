<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Setups – Marks</title>
<style>
  :root { --gap: 12px; --chip-bg:#f7f7f7; --border:#ddd; }
  body { font-family: system-ui, sans-serif; margin: 16px; }
  h1 { margin: 0 0 8px; }
  .muted { color:#666; font-size:12px; margin-top:2px; }

  .btn { appearance:none; border:1px solid #bbb; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn.primary { background:#0b74ff; border-color:#0b74ff; color:#fff; }

  .section { border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:14px; background:#fff; }

  /* Header row */
  .marks-head {
    display:grid;
    grid-template-columns: 100px 1fr repeat(6, 80px) 40px;
    gap:6px; align-items:center;
    font-size:12px; color:#444; font-weight:600; margin-bottom:8px;
  }
  .head-center { text-align:center; }

  /* Mark rows */
  .mark-item {
    display:grid;
    grid-template-columns: 100px 1fr repeat(6, 80px) 40px; /* label | slider | 6 opts | delete */
    gap:6px; align-items:center;
  }
  .mark-label { font-weight:600; }
  .opt-cell { text-align:center; }
  .slider-wrap { grid-column: 2 / 3; }
  input[type="range"] { width:100%; }

  /* Mobile tweaks */
  @media (max-width: 768px) {
    .marks-head { display:none; }
    .mark-item { grid-template-columns: repeat(3, 1fr); grid-auto-rows: auto; }
    .mark-label { grid-column: 1 / -1; }
    .opt-cell { text-align:left; }
    .slider-wrap { grid-column: 1 / -1; order: 99; }
  }

  /* Board / chips */
  .dock { display:flex; flex-wrap:wrap; gap:8px; padding:8px; border:1px dashed #cfcfcf; border-radius:10px; min-height:46px; }
  .board { display:grid; grid-template-columns: repeat(5, 1fr); gap:var(--gap); margin-top:12px; }
  .column { border:1px solid var(--border); border-radius:10px; min-height:140px; padding:8px; display:flex; flex-direction:column; gap:8px; background:#fff; }
  .column-title { font-weight:600; font-size:13px; color:#444; margin-bottom:6px; }

  .chip { user-select:none; padding:8px 10px; border:1px solid #bbb; border-radius:999px; background:var(--chip-bg); font-size:14px; touch-action:none; cursor:grab; }
  .drag-ghost { position:fixed; left:0; top:0; pointer-events:none; transform:translate(-9999px,-9999px); z-index:9999; opacity:.95; box-shadow:0 4px 14px rgba(0,0,0,.15); background:#fff; }
  .drop-hint { outline:2px dashed #0b74ff; outline-offset:-4px; }
</style>
</head>
<body>
  <h1>Setups – Marks</h1>
  <div class="muted" id="ctx">Loading…</div>

  <div class="section" id="marksContainer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <strong>Marks</strong>
      <button class="btn primary" id="addMarkBtn">+ Add</button>
    </div>

    <div class="marks-head">
      <div></div>
      <div class="head-center">Distance</div>
      <div class="head-center">hand tossed</div>
      <div class="head-center">short check down</div>
      <div class="head-center">punch bird</div>
      <div class="head-center">no off</div>
      <div class="head-center">walk up</div>
      <div class="head-center">water mark</div>
      <div></div>
    </div>

    <div class="marks-list" id="marksList"></div>
  </div>

  <div class="section">
    <strong>Dock</strong>
    <div class="dock" id="dock"></div>
  </div>

  <div class="section">
    <strong>Board</strong>
    <div class="board" id="board">
      <div class="column" data-col="col1"><div class="column-title">Column 1</div></div>
      <div class="column" data-col="col2"><div class="column-title">Column 2</div></div>
      <div class="column" data-col="col3"><div class="column-title">Column 3</div></div>
      <div class="column" data-col="col4"><div class="column-title">Column 4</div></div>
      <div class="column" data-col="col5"><div class="column-title">Column 5</div></div>
    </div>
  </div>

  <div class="chip drag-ghost" id="ghost"></div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
  authDomain: "task-tracker-73b77.firebaseapp.com",
  projectId: "task-tracker-73b77",
  storageBucket: "task-tracker-73b77.firebasestorage.app",
  messagingSenderId: "795274673000",
  appId: "1:795274673000:web:0ea07130e45c72384134dd",
  measurementId: "G-VLW5KLY4FF"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- Params / doc ----------
const params = new URL(location.href).searchParams;
const trainer = params.get('trainer') || 'default';
document.getElementById('ctx').textContent = `Trainer: ${trainer}`;
const docRef = db.collection('setups').doc(trainer).collection('configs').doc('marks');

// ---------- State ----------
let state = {
  items: [], // [{id, dist, options}]
  columns: { col1: [], col2: [], col3: [], col4: [], col5: [], dock: [] }
};

// ---------- DOM refs (needed for DnD + rendering) ----------
const dock  = document.getElementById('dock');
const board = document.getElementById('board');
const ghost = document.getElementById('ghost');

// ---------- Helpers ----------
const OPTION_KEYS = [
  { key:'handTossed',     label:'hand tossed' },
  { key:'shortCheckDown', label:'short check down' },
  { key:'punchBird',      label:'punch bird' },
  { key:'noOff',          label:'no off' },
  { key:'walkUp',         label:'walk up' },
  { key:'waterMark',      label:'water mark' },
];

function byId(id){ return state.items.find(i => i.id === id); }
function indexOfId(id){ return state.items.findIndex(i => i.id === id); }
function makeId(){ return 'm_' + Math.random().toString(36).slice(2,9); }
function clampToStep(v){ return Math.max(0, Math.min(400, Math.round(v/25)*25)); }

function markTextFrom(id){
  const item = byId(id);
  const idx = indexOfId(id);
  const number = idx >= 0 ? (idx + 1) : '?';
  const dist = item?.dist ?? 0;
  return `MARK ${number} ${dist}`;
}
function optionsSummary(id){
  const item = byId(id);
  if (!item || !item.options) return '';
  return OPTION_KEYS.filter(o => !!item.options[o.key]).map(o => o.label).join(', ');
}
function ensureAllIdsPlaced() {
  const placed = new Set([
    ...state.columns.dock,
    ...state.columns.col1, ...state.columns.col2, ...state.columns.col3, ...state.columns.col4, ...state.columns.col5
  ]);
  for (const it of state.items) if (!placed.has(it.id)) state.columns.dock.push(it.id);
  for (const k of Object.keys(state.columns)) state.columns[k] = state.columns[k].filter(id => byId(id));
}
async function save() {
  ensureAllIdsPlaced();
  await docRef.set({
    items: state.items,
    columns: state.columns,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

// ---------- UI builders ----------
function renderMarksList() {
  const marksList = document.getElementById('marksList');
  marksList.innerHTML = '';

  state.items.forEach((item) => {
    // defaults for older docs
    item.options = Object.assign({
      handTossed:false, shortCheckDown:false, punchBird:false,
      noOff:false, walkUp:false, waterMark:false
    }, item.options || {});

    const row = document.createElement('div');
    row.className = 'mark-item';
    row.dataset.id = item.id;

    // Label
    const label = document.createElement('div');
    label.className = 'mark-label';
    label.textContent = markTextFrom(item.id);

    // Slider (col 2 on desktop; drops below on mobile via CSS)
    const sliderWrap = document.createElement('div');
    sliderWrap.className = 'slider-wrap';
    const slider = document.createElement('input');
    slider.type = 'range'; slider.min = 0; slider.max = 400; slider.step = 25;
    slider.value = item.dist;
    slider.addEventListener('input', () => {
      item.dist = clampToStep(Number(slider.value));
      label.textContent = markTextFrom(item.id);
      document.querySelectorAll(`.chip[data-id="${item.id}"]`).forEach(c => {
        c.textContent = markTextFrom(item.id);
        const sum = optionsSummary(item.id); c.title = sum || '';
      });
    });
    slider.addEventListener('change', save);
    sliderWrap.appendChild(slider);

    // Option checkboxes
    const optCells = OPTION_KEYS.map(({key, label:optLabel}) => {
      const cell = document.createElement('div');
      cell.className = 'opt-cell';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!item.options[key];
      cb.addEventListener('change', async () => {
        item.options[key] = cb.checked;
        document.querySelectorAll(`.chip[data-id="${item.id}"]`).forEach(c => {
          const sum = optionsSummary(item.id); c.title = sum || '';
        });
        await save();
      });
      cb.title = optLabel;
      cell.appendChild(cb);
      return cell;
    });

    // Delete
    const del = document.createElement('button');
    del.className = 'btn';
    del.textContent = '✖';
    del.title = 'Remove mark';
    del.addEventListener('click', async () => {
      state.items = state.items.filter(x => x.id !== item.id);
      for (const k of Object.keys(state.columns)) state.columns[k] = state.columns[k].filter(id => id !== item.id);
      renderAll();
      await save();
    });

    // Append in fixed order
    row.appendChild(label);        // col 1
    row.appendChild(sliderWrap);   // col 2
    optCells.forEach(c => row.appendChild(c)); // cols 3-8
    row.appendChild(del);          // last col

    marksList.appendChild(row);
  });

  // Refresh MARK # after deletions
  marksList.querySelectorAll('.mark-label').forEach((el, idx) => {
    const id = state.items[idx]?.id;
    if (id) el.textContent = markTextFrom(id);
  });
}

function makeChip(id) {
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.id = id;
  chip.textContent = markTextFrom(id);
  const sum = optionsSummary(id);
  if (sum) chip.title = sum;
  return chip;
}

function renderColumnsAndDock() {
  document.querySelectorAll('.column').forEach(col => {
    const title = col.querySelector('.column-title');
    col.innerHTML = ''; col.appendChild(title);
  });
  dock.innerHTML = '';
  state.columns.dock.forEach(id => dock.appendChild(makeChip(id)));
  ['col1','col2','col3','col4','col5'].forEach(key => {
    const col = document.querySelector(`.column[data-col="${key}"]`);
    state.columns[key].forEach(id => col.appendChild(makeChip(id)));
  });
}

function renderAll(){
  renderMarksList();
  renderColumnsAndDock();
}

// ---------- Drag & drop (chips) ----------
let dragging=null, offsetX=0, offsetY=0;
function setGhost(text,x,y){ ghost.textContent=text; ghost.style.transform=`translate(${x-offsetX}px,${y-offsetY}px)`; }
function containers(){ return [ ...document.querySelectorAll('.column'), dock ]; }
function nearestDropContainer(x, y) {
  let best=null, bestDist=Infinity;
  for (const t of containers()) {
    const r = t.getBoundingClientRect();
    if (x < r.left || x > r.right || y < r.top || y > r.bottom) continue;
    const cx=(r.left+r.right)/2, cy=(r.top+r.bottom)/2;
    const d=Math.hypot(x-cx, y-cy);
    if (d<bestDist){ best=t; bestDist=d; }
  }
  return best;
}
function highlight(el,on){ el.classList.toggle('drop-hint', !!on); }

document.addEventListener('pointerdown', e => {
  const chip = e.target.closest('.chip'); if(!chip) return;
  e.preventDefault(); chip.setPointerCapture?.(e.pointerId);
  dragging = chip;
  const r = chip.getBoundingClientRect();
  offsetX = e.clientX - r.left; offsetY = e.clientY - r.top;
  setGhost(chip.textContent, e.clientX, e.clientY);
});
document.addEventListener('pointermove', e => {
  if (!dragging) return;
  setGhost(dragging.textContent, e.clientX, e.clientY);
  containers().forEach(c => highlight(c,false));
  const t = nearestDropContainer(e.clientX, e.clientY);
  if (t) highlight(t,true);
});
document.addEventListener('pointerup', async e => {
  if (!dragging) return;
  containers().forEach(c => highlight(c,false));
  const id = dragging.dataset.id;
  const t = nearestDropContainer(e.clientX, e.clientY);
  const oldParent = dragging.parentElement;

  if (t) {
    for (const k of Object.keys(state.columns)) state.columns[k] = state.columns[k].filter(x => x !== id);
    const key = t === dock ? 'dock' : t.dataset.col;
    state.columns[key].push(id);
    t.appendChild(dragging);
    await save();
  } else {
    oldParent.appendChild(dragging);
  }
  ghost.style.transform = 'translate(-9999px,-9999px)';
  dragging = null;
});

// ---------- Add mark ----------
document.getElementById('addMarkBtn').addEventListener('click', async () => {
  const id = makeId();
  state.items.push({
    id,
    dist: 0,
    options: { handTossed:false, shortCheckDown:false, punchBird:false, noOff:false, walkUp:false, waterMark:false }
  });
  state.columns.dock.push(id);
  renderAll();
  await save();
});

// ---------- Load (live) ----------
docRef.onSnapshot(snap => {
  if (snap.exists) {
    const data = snap.data() || {};
    state.items = Array.isArray(data.items) ? data.items.map(it => ({
      id: it.id,
      dist: typeof it.dist === 'number' ? clampToStep(it.dist) : 0,
      options: Object.assign({
        handTossed:false, shortCheckDown:false, punchBird:false,
        noOff:false, walkUp:false, waterMark:false
      }, it.options || {})
    })) : [];
    state.columns = Object.assign(
      { col1:[],col2:[],col3:[],col4:[],col5:[],dock:[] },
      data.columns || {}
    );
    ensureAllIdsPlaced();
    renderAll();
  } else {
    save().catch(console.error);
  }
});
</script>
</body>
</html>
