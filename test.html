<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Shift Task Tracker</title>
  <style>
    .container {
      max-width: 600px;
      margin: auto;
    }


.removeReminder {
  font-size: 16px;
  padding: 2px 6px;
  border-radius: 4px;
}
.removeReminder:hover {
  background-color: #fdd;
}



html {
  background-image: url('retriever-outline.png');
  background-repeat: no-repeat;
  background-position: calc(50% + 100px) 0px;
  background-size: 300px auto;
  background-attachment: fixed;
}

body {
  font-family: Arial;
  padding: 20px;
  font-size: 16px;
}



    .task {
      margin: 15px 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .task input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }

    .task label {
      flex-grow: 1;
      margin-right: 10px;
    }

    .timestamp {
      margin-left: auto;
      font-size: 0.9em;
      color: gray;
    }

    .hidden {
      display: none;
    }
	
	#sendBtn {
  margin: 0 5px 10px 0;
  padding: 12px 20px;
  font-size: 16px;
  width: 100%;
  max-width: 200px;
}

	#unsaveBtn {
  margin: 0 5px 10px 0;
  padding: 12px 20px;
  font-size: 16px;
  width: 100%;
  max-width: 200px;
}

.styled-button {
  margin: 0 5px 10px 0 !important;
  padding: 12px 20px !important;
  font-size: 16px !important;
  width: 100% !important;
  max-width: 200px !important;
}


.employee-radio {
  padding: 8px 12px;
  border-radius: 6px;
  color: black;
  font-weight: bold;
}

.bg-BG { background-color: #b2f0e6; }
.bg-BJ { background-color: #d1d5ff; }
.bg-CG { background-color: #f7dcae; }
.bg-SG { background-color: #e2c2f9; }


    .button-row button {
      margin: 0 5px 10px 0;
      padding: 12px 20px;
      font-size: 16px;
      width: 100%;
      max-width: 200px;
    }
    body { font-family: Arial; padding: 20px; }
    .task { margin: 10px 0; }
    .timestamp { margin-left: 10px; font-size: 0.9em; color: gray; }
    .hidden { display: none; }
    .button-row button {
      margin: 0 5px 10px 0;
      padding: 8px 16px;
      font-size: 14px;
    }
	
#dataControls button {
  margin-top: 10px;
}

#toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #4CAF50; /* green */
  color: white;
  padding: 14px 24px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}
#toast.show {
  opacity: 1;
}

.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 28px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0;
  right: 0; bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #4CAF50;
}

input:checked + .slider:before {
  transform: translateX(32px);
}

#sendBtn, #unsaveBtn {
  display: none !important;
}




  </style>

  <!-- Firebase App + Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js">
window.addEventListener('DOMContentLoaded', async () => {
  const today = new Date().toLocaleDateString('en-US');
  const docId = `${today}_AM`;

const employeeColors = {
  BG: '#b2f0e6', // light teal
  BJ: '#d1d5ff', // soft blue
  CG: '#f7dcae', // warm beige
  SG: '#e2c2f9'  // light purple
};


  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (docSnap.exists) {
      const report = docSnap.data();
      currentShift = report.shift;
      timestamps = {};
      checkedStates = {};

      report.tasks.forEach((task, i) => {
        const id = `${currentShift}_task${i}`;
        checkedStates[id] = task.checked;
        timestamps[id] = task.time;
      });

      renderTasks(currentShift);
      document.getElementById('taskList').classList.remove('hidden');
      document.getElementById('sendBtn').classList.remove('hidden');
	  document.getElementById('unsaveBtn').classList.remove('hidden');

    }
  } catch (err) {
    console.error("Auto-load error:", err);
  }
  
  
});

</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js">






</script>
</head>
<body>
<div id="toast"></div>

<h2 id="headerTitle" style="background-color: white; padding: 10px; border-radius: 8px; display: inline-block; margin: 0;">
  <span id="currentDate"></span>
</h2>

<div id="windToggle" onclick="toggleWindInfo()" 
     style="cursor: pointer; font-size: 18px; margin-bottom: 10px; white-space: normal; word-break: break-word;
            background-color: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            width: fit-content;">
  üß≠ Wind: Loading...
</div>



<div id="wind-info" 
     style="display: none; margin-top: 8px; background: white; padding: 12px 16px; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15); line-height: 1.6; font-size: 14px; width: fit-content;">
</div>





<div id="topReminderAdd" onclick="showReminderInput()" 
     style="margin-bottom: 20px;
            background-color: #228B22; color: white;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: inline-block;
            font-size: 14px;">
  + Add Reminder
</div>


<div id="scheduleTestBtn" onclick="showTestForm()" 
     style="margin-bottom: 20px;
            background-color: #7e22ce; color: white;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            font-size: 14px;
            display: block;
            width: fit-content;">
  üìÖ Schedule Test Sign Up
</div>

<div>
<div id="toggleMorningBtn" onclick="toggleMorningFeeds()" 
     style="margin-top: 10px; background-color: #228B22; color: white; 
            padding: 6px 12px; border-radius: 6px; 
            cursor: pointer; font-weight: bold; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: inline-block;">
  ‚ûï Show Morning Feeds
</div>


  <div id="morningFeeds" style="display: none; margin-top: 8px;">
    <div style="color: #333; font-weight: bold;">üçΩÔ∏è Morning Feeds:</div>
 <div id="morningWarning" style="white-space: pre-line; color: #333; font-size: 18px;"></div>
 </div>
</div>

<div id="dogWarnings" style="margin: 10px 0; display: none;">
  <div style="margin-bottom: 8px;">
    <div style="color: green; font-weight: bold;">‚ö†Ô∏è Medicine Notes:</div>
    <div id="medicineWarning" style="white-space: pre-line; color: green;"></div>
  </div>
  <div>
    <div style="color: red; font-weight: bold;">üî• In Heat:</div>
    <div id="heatWarning" style="white-space: pre-line; color: red;"></div>
  </div>
</div>

<div id="testListBox" style="display: none; margin-top: 20px;">
  <h3>Tests & Trials</h3>
  <ul id="testList" style="list-style-type: none; padding: 0;"></ul>
</div>



<div id="testFormModal" style="display: none; padding: 20px; border: 1px solid #ccc; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); max-width: 400px;">
  <h3>Schedule a Test</h3>
  <input type="text" id="testName" placeholder="Test Name" style="width: 100%; margin-bottom: 8px;"><br>
  <input type="date" id="testDate" style="width: 100%; margin-bottom: 8px;"><br>
  <input type="time" id="testTime" value="20:00" style="width: 100%; margin-bottom: 8px;">
  <button onclick="saveTestSignup()">Save</button>
  <button onclick="closeTestForm()">Cancel</button>
</div>




<div class="container">




  
  
<div id="shiftToggleRow">
  <div class="button-row" style="justify-content: center; align-items: center; margin-bottom: 10px;">
    <span style="margin-right: 12px; font-weight: bold; font-size: 16px;">AM</span>
    <label class="switch">
      <input type="checkbox" id="shiftToggle">
      <span class="slider round"></span>
    </label>
    <span style="margin-left: 12px; font-weight: bold; font-size: 16px;">PM</span>
  </div>
</div>





<div class="button-row" id="employeeRow">
  <span style="font-weight: bold; align-self: center;">Employee:</span>

  <label class="employee-radio bg-BG"><input type="radio" name="employeeId" value="BG"> BG</label>
  <label class="employee-radio bg-BJ"><input type="radio" name="employeeId" value="BJ"> BJ</label>
  <label class="employee-radio bg-CG"><input type="radio" name="employeeId" value="CG"> CG</label>
  <label class="employee-radio bg-SG"><input type="radio" name="employeeId" value="SG"> SG</label>
</div>












<style>
#employeeRow {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  font-size: 16px;
}
#employeeRow label {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
}
</style>




  <div id="taskList" class="hidden"></div>

<div id="dataControls" class="hidden">
  <div style="margin-bottom: 12px;">
    <label style="margin-right: 10px;">Shift:</label>
    <div id="dataShiftToggleWrapper" style="display: inline-flex; align-items: center; margin-bottom: 10px;">
      <span style="margin-right: 8px; font-weight: bold;">AM</span>
      <label class="switch">
        <input type="checkbox" id="dataShiftToggle">
        <span class="slider round"></span>
      </label>
      <span style="margin-left: 8px; font-weight: bold;">PM</span>
    </div>

    <div style="margin-top: 5px;">
      <label for="manualDatePicker">Select Date:</label>
      <input type="date" id="manualDatePicker" style="width: 220px; height: 40px; font-size: 16px;">

    </div>

    <label for="manualDate" style="display: none;">or enter date:</label>
    <input type="text" id="manualDate" style="width: 120px; display: none;">
  </div>


<div style="display: flex; gap: 10px; margin: 10px 0;">
  <button class="styled-button" onclick="loadSelectedData()">View Report</button>
  <button id="returnToTasksBtn" class="styled-button hidden" onclick="returnToTasks()">Return to Tasks</button>
</div>



</div>

<div id="dogInfoSection" class="hidden">
  <h3>Dog Info</h3>
  
<button class="styled-button" style="margin-bottom: 20px;" onclick="returnToTasks()">Return to Tasks</button>

  <div style="margin-bottom: 20px;">
    <h4>Medicine</h4>
    <textarea id="medicineNotes" style="width: 100%; height: 100px;"></textarea>
    <button class="styled-button" onclick="saveDogNote('medicine')">Save Medicine Note</button>
  </div>

  <div>
    <h4>Girls in Heat</h4>
    <textarea id="heatNotes" style="width: 100%; height: 100px;"></textarea>
    <button class="styled-button" onclick="saveDogNote('heat')">Save Heat Note</button>
  </div>
  
  <div style="margin-top: 20px;">
  <h4>Morning Feeds</h4>
  <textarea id="morningNotes" style="width: 100%; height: 100px;"></textarea>
  <button class="styled-button" onclick="saveDogNote('morning')">Save Morning Feed Note</button>
</div>

<div style="margin-top: 20px;">
  <h4>Reminders</h4>
 <textarea id="remindersNotes" style="width: 100%; height: 100px;"></textarea>
<button class="styled-button" onclick="saveDogNote('reminders')">Save Reminders</button>
</div>



  <button class="styled-button" style="margin-top: 20px;" onclick="returnToTasks()">Return to Tasks</button>
</div>




<div id="reminderBox" style="margin-top: 10px; display: none;">
  <div style="font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
    üìå <span style="color: #7e22ce;">Reminders:</span>
    <button id="addReminderBtn" title="Add Reminder" style="font-size: 18px; padding: 2px 6px; cursor: pointer; background: none; border: none; color: #7e22ce; font-weight: bold;">‚ûïAdd</button>
  </div>
  <div id="reminderList" style="white-space: pre-line;"></div>
</div>



  <div id="dataView" class="hidden"></div>

<!-- Place this inside your bottom .button-row -->
<div class="button-row" style="justify-content: center;">
  <button id="sendBtn" class="hidden">Save Report</button>
  <button id="unsaveBtn" class="hidden">Unsave Checked</button>
  <button id="goToDataBtn" class="styled-button" onclick="goToData()">Reports</button> <!-- ‚úÖ New button -->
  <button id="goToDogInfoBtn" class="styled-button" onclick="goToDogInfo()">Dog Info</button>

</div>



  <script>
    // ‚úÖ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.firebasestorage.app",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

window.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');

  const formattedDate = `${yyyy}-${mm}-${dd}`; // Works with <input type="date">
  document.getElementById('manualDatePicker').value = formattedDate;

  loadTestSignups(); // ‚úÖ Your tests & trials section
});


function formatDisplayDate(dateStr) {
  const [yyyy, mm, dd] = dateStr.split('-');
  return `${mm}/${dd}/${yyyy.slice(-2)}`; // MM/DD/YY
}


function formatDisplayTime(timeStr) {
  const [hour, minute] = timeStr.split(":");
  const dt = new Date();
  dt.setHours(hour, minute);
  return dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

function toggleWindInfo() {
  const box = document.getElementById("wind-info");
  const toggle = document.getElementById("windToggle");

  const isHidden = box.style.display === "none";
  box.style.display = isHidden ? "block" : "none";

  if (!isHidden) {
    updateWindSummary(); // restore collapsed view text
  }
}



// Set today's date as the placeholder for the manual date input
const manualDateInput = document.getElementById('manualDate');
const today = new Date().toLocaleDateString('en-US');
manualDateInput.placeholder = today;


    const tasks = {
      AM: [
        'Aired Males',
        'Aired Females',
        'Morning Feed',
        'Medicine',
        'Checked Chlorine Gun Young',
        'Cleaned Young Dog Kennel',
        'Checked Chlorine Gun Old',
        'Cleaned Finished Dog Kennel',
        'Trough Young Dogs',
        'Trough Old Dogs',
        'Turned Off Water Young Dog Kennel',
        'Turned Off Water Finished Dog Kennel',
		'Cleaned Airing Lots',
        'Clipped Gates'
             ],
      PM: ['Medicine', 'Fed Dogs', 'Aired Males (Old)', 'Aired Females (Old)', 'Aired Males (Young)', 'Aired Females (Young)', 'Cleaned Airing Yards', 'Clip/Dog Check (Old)', 'Clip/Dog Check (Young)', 'Water Hose Check (Old)', 'Water Hose Check (Young)', 'Water Off Check (Old)', 'Water Off Check (Young)', 'Trailer Holes Empty/Clean', 'Washed Bowls','Ducks In Freezer', 'Charging Devices','Gas Check', 'Clipped Gates']
    };

    let currentShift = null;
    let timestamps = {};
    let checkedStates = {};
	let employeeIds = {};
let unsubscribeListener = null;


    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US');

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

const employeeColors = {
  BG: '#b2f0e6', // light teal
  BJ: '#d1d5ff', // soft blue
  CG: '#f7dcae', // warm beige
  SG: '#e2c2f9'  // light purple
};


    async function selectShift(mode) {
      const taskList = document.getElementById('taskList');
      const dataView = document.getElementById('dataView');
      const dataControls = document.getElementById('dataControls');
      const sendBtn = document.getElementById('sendBtn');
		const shiftToggleRow = document.getElementById('shiftToggleRow');

      if (mode === 'DATA') {
	  shiftToggleRow.style.display = 'none';
  currentShift = null;
  taskList.classList.add('hidden');
  sendBtn.classList.add('hidden');
  document.getElementById('unsaveBtn').classList.add('hidden');
  dataControls.classList.remove('hidden');
  dataView.classList.remove('hidden');
  dataView.innerHTML = '';
  document.getElementById('employeeRow').style.display = 'none'; // ‚úÖ hide radios
} else {
loadDogWarnings();

shiftToggleRow.style.display = 'block';
  currentShift = mode;
  timestamps = {};
  checkedStates = {};
  const today = new Date().toLocaleDateString('en-US');
  const docId = `${today}_${mode}`;

 if (unsubscribeListener) unsubscribeListener(); // cleanup any previous listener

unsubscribeListener = db.collection("reports").doc(docId).onSnapshot((docSnap) => {
  if (!docSnap.exists) {
    console.log("No saved data for", docId);
    return;
  }

  const report = docSnap.data();
  currentShift = report.shift;
  timestamps = {};
  checkedStates = {};
  employeeIds = {};

  tasks[report.shift].forEach((taskName, i) => {
    const id = `${report.shift}_task${i}`;
    const savedTask = report.tasks.find(t => t.name === taskName);
    if (savedTask) {
      checkedStates[id] = savedTask.checked;
      timestamps[id] = savedTask.time;
      employeeIds[id] = savedTask.employee || "Unknown";
    }
  });

  console.log(`Live update: Loaded tasks for ${docId}:`, report.tasks);
  renderTasks(currentShift);
});

  renderTasks(mode);
  taskList.classList.remove('hidden');
  sendBtn.classList.remove('hidden');
  document.getElementById('unsaveBtn').classList.remove('hidden');
  dataControls.classList.add('hidden');
  dataView.classList.add('hidden');
  document.getElementById('employeeRow').style.display = 'flex'; // ‚úÖ show radios
}

    }

   function renderTasks(shift) {
  const container = document.getElementById('taskList');
  container.innerHTML = '';

 tasks[shift].forEach((task, i) => {
  const id = `${shift}_task${i}`;
  const div = document.createElement('div');

  const isChecked = checkedStates[id] || false;
  const emp = employeeIds[id] || "Unknown";
  const bgColor = isChecked ? (employeeColors[emp] || '#e0ffe0') : (i % 2 === 0 ? '#f9f9f9' : '#ffffff');

  div.className = 'task';
  div.style.background = bgColor;

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = id;
  checkbox.checked = isChecked;
  if (isChecked) checkbox.setAttribute('data-employee', emp);


  checkbox.onchange = () => {
    const now = new Date().toLocaleTimeString();
    checkedStates[id] = checkbox.checked;
    timestamps[id] = now;
if (checkbox.checked) {
  const selectedRadio = document.querySelector('input[name="employeeId"]:checked');
  const emp = selectedRadio ? selectedRadio.value : "Unknown";
  employeeIds[id] = emp;
  checkbox.setAttribute('data-employee', emp);  // ‚úÖ Save it to the DOM too
} else {
  checkbox.removeAttribute('data-employee');  // Optional cleanup
}

    // Retain previous employee ID if already saved
    if (checkbox.checked && !employeeIds[id]) {
      const selectedRadio = document.querySelector('input[name="employeeId"]:checked');
      employeeIds[id] = selectedRadio ? selectedRadio.value : "Unknown";
    }

    document.getElementById(`ts_${id}`).textContent = checkbox.checked
      ? `${timestamps[id]}`
      : 'Unchecked';

    // Update background on toggle
    div.style.background = checkbox.checked
      ? (employeeColors[employeeIds[id]] || '#e0ffe0')
      : (i % 2 === 0 ? '#f9f9f9' : '#ffffff');
	  saveSingleTask(id); // auto-save this task

  };

  const label = document.createElement('label');
  label.htmlFor = id;
  label.textContent = task;

  const tsSpan = document.createElement('span');
  tsSpan.id = `ts_${id}`;
  tsSpan.className = 'timestamp';
  tsSpan.textContent = isChecked
    ? `${timestamps[id] || "Now"}`
    : 'Unchecked';

  div.appendChild(checkbox);
  div.appendChild(label);
  div.appendChild(tsSpan);

  container.appendChild(div);
});

}

function goToData() {
  document.getElementById('goToDataBtn').classList.add('hidden');
  document.getElementById('returnToTasksBtn').classList.remove('hidden');
  document.getElementById('reminderBox').style.display = 'none';

  selectShift('DATA');
}

function returnToTasks() {
  document.getElementById('goToDataBtn').classList.remove('hidden');
  document.getElementById('goToDogInfoBtn').classList.remove('hidden');
  document.getElementById('dogInfoSection').classList.add('hidden'); // üëà HIDE Dog Info
  document.getElementById('dataControls').classList.add('hidden');   // üëà HIDE Data Controls
  document.getElementById('dataView').classList.add('hidden');       // üëà HIDE Data View

  document.getElementById('taskList').classList.remove('hidden');
  document.getElementById('sendBtn').classList.remove('hidden');
  document.getElementById('unsaveBtn').classList.remove('hidden');
  document.getElementById('employeeRow').style.display = 'flex';
  document.getElementById('shiftToggleRow').style.display = 'block';

  // Restore current shift based on toggle
  const shift = document.getElementById('shiftToggle').checked ? 'PM' : 'AM';
  selectShift(shift);
}



function goToDogInfo() {
  document.getElementById('goToDataBtn').classList.add('hidden');
  document.getElementById('goToDogInfoBtn').classList.add('hidden');
  document.getElementById('dogInfoSection').classList.remove('hidden');
  document.getElementById('taskList').classList.add('hidden');
  document.getElementById('dataControls').classList.add('hidden');
  document.getElementById('dataView').classList.add('hidden'); // ‚úÖ hide viewed report
  document.getElementById('sendBtn').classList.add('hidden');
  document.getElementById('unsaveBtn').classList.add('hidden');
document.getElementById('reminderBox').style.display = 'none';

  loadDogNotes(); // Load existing notes
}


async function saveDogNote(type, newReminder = null) {
  const docRef = db.collection("dogInfo").doc("current");
  let value;

  if (type === "reminders") {
    const doc = await docRef.get();
    const currentReminders = doc.exists && Array.isArray(doc.data().reminders)
      ? doc.data().reminders
      : [];

    if (newReminder) {
      // Append mode
      value = [...currentReminders, newReminder.trim()];
    } else {
      // Get from textarea
      value = document.getElementById(`${type}Notes`).value
        .split('\n')
        .map(line => line.trim())
        .filter(line => line);
    }
  } else {
    value = document.getElementById(`${type}Notes`).value;
  }

  console.log("Saving", type, value);
  await docRef.set({ [type]: value }, { merge: true });

  showToast("Saved!");
  loadDogWarnings(); // So the UI updates after saving
}



async function loadDogNotes() {
  const docRef = db.collection("dogInfo").doc("current");
  const doc = await docRef.get();

  if (doc.exists) {
    const data = doc.data();
    document.getElementById("medicineNotes").value = data.medicine || '';
    document.getElementById("heatNotes").value = data.heat || '';
	document.getElementById("morningNotes").value = data.morning || '';
	document.getElementById("remindersNotes").value = (data.reminders || []).join('\n');

  }
}

async function loadDogWarnings() {
  const warningBox = document.getElementById('dogWarnings');
  const medDiv = document.getElementById('medicineWarning');
  const heatDiv = document.getElementById('heatWarning');
  const morningDiv = document.getElementById('morningWarning');
  const reminderBox = document.getElementById('reminderBox');
  const reminderList = document.getElementById('reminderList');

  try {
    const doc = await db.collection("dogInfo").doc("current").get();

    if (doc.exists) {
      const data = doc.data();
      const meds = data.medicine || '';
      const heat = data.heat || '';
      const morning = data.morning || '';
      const reminders = data.reminders || [];

      medDiv.innerHTML = meds.split('\n').map(line => `<div style="color: green;">${line}</div>`).join('');
      heatDiv.innerHTML = heat.split('\n').map(line => `<div style="color: red;">${line}</div>`).join('');
      morningDiv.innerHTML = morning.split('\n').map(line => `<div>${line}</div>`).join('');

      if (reminders.length > 0) {
reminderList.innerHTML = reminders.map((text, i) =>
  `<div class="task" data-index="${i}">
    <input type="checkbox" id="reminder_${i}" class="reminderCheckbox">
    <label for="reminder_${i}">${text}</label>
    <button class="removeReminder" data-index="${i}" style="margin-left: 10px; background: none; border: none; color: red; font-weight: bold; cursor: pointer;">‚úñ</button>
  </div>`
).join('');




        reminderBox.style.display = 'block';
      } else {
        reminderBox.style.display = 'none';
      }

      warningBox.style.display = (meds || heat || morning) ? 'block' : 'none';
    } else {
      warningBox.style.display = 'none';
      reminderBox.style.display = 'none';
    }
  } catch (err) {
    console.error("Error loading dog warnings:", err);
    warningBox.style.display = 'none';
    reminderBox.style.display = 'none';
  }
}

document.getElementById("addReminderBtn").addEventListener("click", async () => {
  const newReminder = prompt("Enter new reminder:");
  if (!newReminder) return;

  const docRef = db.collection("dogInfo").doc("current");
  const doc = await docRef.get();

  if (!doc.exists) return;

  let reminders = doc.data().reminders || [];
  reminders.push(newReminder.trim());

  await docRef.set({ reminders }, { merge: true });

  showToast("Reminder added!");
  loadDogWarnings(); // Refresh to show new entry
});


document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('removeReminder')) {
    const i = parseInt(e.target.dataset.index);
    const checkbox = document.getElementById(`reminder_${i}`);
    
    if (!checkbox.checked) {
      alert("Check the reminder first to confirm deletion.");
      return;
    }

    // Load current reminders
    const docRef = db.collection("dogInfo").doc("current");
    const doc = await docRef.get();
    if (!doc.exists) return;

    let reminders = doc.data().reminders || [];

    // Remove by index
    reminders.splice(i, 1);

    // Save new list
    await docRef.set({ reminders }, { merge: true });

    showToast("Reminder removed");
    loadDogWarnings(); // Refresh the view
  }
});


function toggleMorningFeeds() {
  const content = document.getElementById("morningFeeds");
  const button = document.getElementById("toggleMorningBtn");

  if (content.style.display === "none") {
    content.style.display = "block";
    button.textContent = "‚ûñ Hide Morning Feeds";
  } else {
    content.style.display = "none";
    button.textContent = "‚ûï Show Morning Feeds";
  }
}

function showReminderInput() {
  const reminder = prompt("Enter new reminder:");
  if (reminder) saveDogNote('reminders', reminder);
}

function showTestForm() {
  document.getElementById('testFormModal').style.display = 'block';
}
function closeTestForm() {
  document.getElementById('testFormModal').style.display = 'none';
}

async function saveTestSignup() {
  const name = document.getElementById('testName').value.trim();
  const date = document.getElementById('testDate').value;
  const time = document.getElementById('testTime').value;

  if (!name || !date || !time) {
    alert("Please fill out all fields.");
    return;
  }

  await db.collection("testSignups").add({ name, date, time });
  closeTestForm();
  loadTestSignups();
  showToast("Test scheduled!");
}

async function loadTestSignups() {
  const snapshot = await db.collection("testSignups").get();
  const list = document.getElementById("testList");
  const box = document.getElementById("testListBox");

  if (snapshot.empty) {
    box.style.display = "none";
    return;
  }

  list.innerHTML = '';
  snapshot.forEach(doc => {
    const { name, date, time } = doc.data();
    const id = doc.id;

    const link = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(name)}&dates=${formatGoogleCalTime(date, time)}/${formatGoogleCalTime(date, time, 1)}&location=${encodeURIComponent(name)}&details=${encodeURIComponent("Scheduled test")}`;

list.innerHTML += `
  <li style="margin-bottom: 10px;">
    <a href="${link}" target="_blank" style="margin-right: 10px;">
      ${name} @ ${formatDisplayDate(date)} ${formatDisplayTime(time)}
    </a>
    <button onclick="deleteTest('${id}')" style="color: red; background: none; border: none; font-weight: bold;">‚úñ</button>
  </li>`;

  });

  box.style.display = "block";
}

// Helper for Google Calendar date formatting
function formatGoogleCalTime(dateStr, timeStr, addHour = 0) {
  const dt = new Date(`${dateStr}T${timeStr}`);
  if (addHour) dt.setHours(dt.getHours() + addHour);
  return dt.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
}

async function deleteTest(id) {
  await db.collection("testSignups").doc(id).delete();
  loadTestSignups();
  showToast("Test removed.");
}

function degreesToCardinal(degree) {
      const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      const index = Math.round(degree / 45) % 8;
      return directions[index];
    }
	
function updateWindSummary() {
  fetch('https://api.open-meteo.com/v1/forecast?latitude=36.0345&longitude=-89.3856&current_weather=true&hourly=winddirection&timezone=auto')
    .then(response => response.json())
    .then(data => {
      const now = new Date();
      const hours = data.hourly.time;
      const directions = data.hourly.winddirection;

      const getDir = deg => {
        const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        return dirs[Math.round(deg / 45) % 8];
      };

      const summary = [];

      // Add current wind direction
      const current = data.current_weather.winddirection;
      summary.push(getDir(current));

      // Get next 3 hours
      let count = 0;
      for (let i = 0; i < hours.length && count < 3; i++) {
        const t = new Date(hours[i]);
        const diff = (t - now) / (1000 * 60 * 60);
        if (diff >= 1 && diff <= 4) {
          summary.push(getDir(directions[i]));
          count++;
        }
      }

      document.getElementById("windToggle").textContent = `üß≠ Wind: ${summary.join(" ‚Üí ")}`;
    })
    .catch(err => {
      document.getElementById("windToggle").textContent = "üß≠ Wind: N/A";
      console.error("Wind summary error:", err);
    });
}



fetch('https://api.open-meteo.com/v1/forecast?latitude=36.0345&longitude=-89.3856&current_weather=true&hourly=winddirection,windspeed&timezone=auto')
  .then(response => response.json())
  .then(data => {
    const currentWindDir = data.current_weather.winddirection;
    const currentWindSpeedKph = data.current_weather.windspeed;
    const currentWindSpeedMph = (currentWindSpeedKph * 0.621371).toFixed(1);

    const now = new Date();
    const hours = data.hourly.time;
    const directions = data.hourly.winddirection;
    const speeds = data.hourly.windspeed;

    const getDirectionLabel = deg => {
      const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW', 'N'];
      return dirs[Math.round(deg / 45) % 8];
    };

    let html = `<strong>Wind Now:</strong> ${getDirectionLabel(currentWindDir)} (${currentWindDir}¬∞) at ${currentWindSpeedMph} mph<br><br>`;

    let count = 0;
    for (let i = 0; i < hours.length; i++) {
      const forecastTime = new Date(hours[i]);
      const diffHours = (forecastTime - now) / (1000 * 60 * 60);

      if (diffHours >= 1 && count < 8) {
        const labelTime = forecastTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const direction = directions[i];
        const dirLabel = getDirectionLabel(direction);
        const speedMph = (speeds[i] * 0.621371).toFixed(1);
        html += `${labelTime}: ${dirLabel} (${direction}¬∞) at ${speedMph} mph<br>`;
        count++;
      }
    }

    document.getElementById('wind-info').innerHTML = html;
  })
  .catch(error => console.error('Error fetching wind data:', error));




async function saveReport() {
  if (!currentShift) return;

  const employeeRadios = document.getElementsByName('employeeId');
  let selectedEmployee = null;
  for (let radio of employeeRadios) {
    if (radio.checked) {
      selectedEmployee = radio.value;
      break;
    }
  }

  if (!selectedEmployee) {
    alert("Please select your employee ID before saving.");
    return;
  }

  const date = new Date().toLocaleDateString('en-US');
  const docId = `${date}_${currentShift}`;

  let existingTasks = [];
  try {
    const docSnap = await db.collection("reports").doc(docId).get();
    if (docSnap.exists) {
      existingTasks = docSnap.data().tasks || [];
    }
  } catch (err) {
    console.warn("Error fetching existing tasks:", err);
  }

  const updatedTasks = [];

  tasks[currentShift].forEach((task, i) => {
    const id = `${currentShift}_task${i}`;
    const checkbox = document.getElementById(id);
    const time = timestamps[id] || '';
    const prevEmp = checkbox?.getAttribute('data-employee') || 'Unknown';

    if (checkbox?.checked) {
      const employee = employeeIds[id] || selectedEmployee;

      updatedTasks.push({ name: task, time, checked: true, employee });
    }
  });

  // Filter out only the tasks being updated from the existing list
  const mergedTasks = [
    ...existingTasks.filter(t => !updatedTasks.some(n => n.name === t.name)),
    ...updatedTasks
  ];

  await db.collection("reports").doc(docId).set({
    date,
    shift: currentShift,
    tasks: mergedTasks
  });

  showToast("‚úÖ Saved!");
console.log(`Saved data for ${docId}:`, mergedTasks);

  // Refresh checkboxes to reflect everyone‚Äôs latest saved state
  await selectShift(currentShift);
}


async function saveSingleTask(taskId) {
  if (!currentShift) return;

  const employeeRadios = document.getElementsByName('employeeId');
  let selectedEmployee = null;
  for (let radio of employeeRadios) {
    if (radio.checked) {
      selectedEmployee = radio.value;
      break;
    }
  }

  if (!selectedEmployee) {
    alert("Please select your employee ID before updating.");
    return;
  }

  const date = new Date().toLocaleDateString('en-US');
  const docId = `${date}_${currentShift}`;
  const index = parseInt(taskId.split('_task')[1]);
  const taskName = tasks[currentShift][index];

  const checkbox = document.getElementById(taskId);
  const time = timestamps[taskId] || new Date().toLocaleTimeString();
  const employee = employeeIds[taskId] || selectedEmployee;

  try {
    const docRef = db.collection("reports").doc(docId);
    const docSnap = await docRef.get();
    let taskList = [];

    if (docSnap.exists) {
      const existing = docSnap.data().tasks || [];
      taskList = existing.filter(t => t.name !== taskName);
    }

    if (checkbox.checked) {
      taskList.push({ name: taskName, time, checked: true, employee });
    }

    await docRef.set({
      date,
      shift: currentShift,
      tasks: taskList
    });

    console.log(`Auto-saved task ${taskName}`);
  } catch (err) {
    console.error("Auto-save failed:", err);
  }
}





async function unsaveChecked() {
  if (!currentShift) return;

  const date = new Date().toLocaleDateString('en-US');
  const docId = `${date}_${currentShift}`;

  try {
    const docSnap = await db.collection("reports").doc(docId).get();
    if (!docSnap.exists) {
      alert("No saved report found to update.");
      return;
    }

    let existingTasks = docSnap.data().tasks || [];
    const toRemove = [];

    tasks[currentShift].forEach((task, i) => {
      const id = `${currentShift}_task${i}`;
      const checkbox = document.getElementById(id);
      if (checkbox?.checked) {
        toRemove.push(task);
      }
    });

    const updatedTasks = existingTasks.filter(t => !toRemove.includes(t.name));

    await db.collection("reports").doc(docId).update({ tasks: updatedTasks });

    alert("Selected tasks removed from saved report.");
    await selectShift(currentShift); // Refresh view
  } catch (err) {
    console.error("Error during unsave:", err);
    alert("Failed to update report.");
  }
}



async function loadSelectedData() {
  const datePickerValue = document.getElementById('manualDatePicker').value;
  const manualDateValue = document.getElementById('manualDate').value.trim();
  const shift = document.getElementById('dataShiftToggle').checked ? 'PM' : 'AM';

  const dataView = document.getElementById('dataView');

  const dateToUse = datePickerValue || manualDateValue;
  if (!dateToUse) return alert("Please select or enter a date.");

  let formattedDate;
if (datePickerValue) {
  const [year, month, day] = datePickerValue.split("-");
  formattedDate = `${parseInt(month)}/${parseInt(day)}/${year}`;
} else {
  formattedDate = new Date(manualDateValue).toLocaleDateString('en-US');
}

  const docId = `${formattedDate}_${shift}`;
  dataView.innerHTML = '';

  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (!docSnap.exists) {
      dataView.innerHTML = `<p>No data found for ${formattedDate} (${shift}).</p>`;
      console.warn("No document found for ID:", docId);
      return;
    }

    const report = docSnap.data();
    console.log(`Loaded from Firebase [${docId}]:`, report.tasks);

dataView.innerHTML = `
  <strong>Date:</strong> ${report.date}<br>
  <strong>Shift:</strong> ${report.shift}<br>
  <ul style="list-style-type: none; padding: 0;">
    ${tasks[report.shift].map((taskName, i) => {
      const saved = report.tasks.find(t => t.name === taskName);
      const timeStr = saved?.checked ? saved.time : "<strong>Not completed</strong>";
      const emp = saved?.employee || "Unknown";
      const bg = i % 2 === 0 ? '#e9f0ff' : '#ffffff';
      return `<li style="padding: 10px 14px; background: ${bg}; border-bottom: 1px solid #ccc;">
        ${taskName} - ${timeStr} <em>(by ${emp})</em>
      </li>`;
    }).join('')}
  </ul>
`;





  } catch (err) {
    console.error("Error loading report:", err);
    dataView.innerHTML = `<p style="color:red;">Error loading data.</p>`;
  }
}

document.getElementById('shiftToggle').addEventListener('change', function() {
  const shift = this.checked ? 'PM' : 'AM';
  selectShift(shift);
  document.getElementById('dataToggleBtn').textContent = 'DATA';
});


    document.getElementById('sendBtn').addEventListener('click', saveReport);
	document.getElementById('unsaveBtn').addEventListener('click', unsaveChecked);
document.getElementById('manualDatePicker').addEventListener('change', () => {
  document.getElementById('manualDate').value = '';
});

  
window.addEventListener('DOMContentLoaded', () => {
const currentHour = new Date().getHours();
const shiftToLoad = currentHour < 12 ? 'AM' : 'PM';
document.getElementById('shiftToggle').checked = (shiftToLoad === 'PM'); // ‚úÖ Set slider position
updateWindSummary();

selectShift(shiftToLoad);
// Restore saved employee ID
const savedId = localStorage.getItem('lastEmployeeId');
if (savedId) {
  const savedRadio = document.querySelector(`input[name="employeeId"][value="${savedId}"]`);
  if (savedRadio) savedRadio.checked = true;
}

// Save new selection on change
document.querySelectorAll('input[name="employeeId"]').forEach(radio => {
  radio.addEventListener('change', () => {
    localStorage.setItem('lastEmployeeId', radio.value);
  });
});

});

document.getElementById('shiftToggle').addEventListener('change', function() {
  const shift = this.checked ? 'PM' : 'AM';
  selectShift(shift);
});


</script>

</div>
</body>
</html>
