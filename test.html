<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Shift Task Tracker</title>
  <style>
    .container {
      max-width: 600px;
      margin: auto;
    }

    body {
      font-family: Arial;
      padding: 20px;
      font-size: 16px;
    }

    .task {
      margin: 15px 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .task input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }

    .task label {
      flex-grow: 1;
      margin-right: 10px;
    }

    .timestamp {
      margin-left: auto;
      font-size: 0.9em;
      color: gray;
    }

    .hidden {
      display: none;
    }
	
	#sendBtn {
  margin: 0 5px 10px 0;
  padding: 12px 20px;
  font-size: 16px;
  width: 100%;
  max-width: 200px;
}

	#unsaveBtn {
  margin: 0 5px 10px 0;
  padding: 12px 20px;
  font-size: 16px;
  width: 100%;
  max-width: 200px;
}

.styled-button {
  margin: 0 5px 10px 0;
  padding: 12px 20px;
  font-size: 16px;
  width: 100%;
  max-width: 200px;
}



    .button-row button {
      margin: 0 5px 10px 0;
      padding: 12px 20px;
      font-size: 16px;
      width: 100%;
      max-width: 200px;
    }
    body { font-family: Arial; padding: 20px; }
    .task { margin: 10px 0; }
    .timestamp { margin-left: 10px; font-size: 0.9em; color: gray; }
    .hidden { display: none; }
    .button-row button {
      margin: 0 5px 10px 0;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>

  <!-- Firebase App + Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js">
window.addEventListener('DOMContentLoaded', async () => {
  const today = new Date().toLocaleDateString('en-US');
  const docId = `${today}_AM`;

  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (docSnap.exists) {
      const report = docSnap.data();
      currentShift = report.shift;
      timestamps = {};
      checkedStates = {};

      report.tasks.forEach((task, i) => {
        const id = `${currentShift}_task${i}`;
        checkedStates[id] = task.checked;
        timestamps[id] = task.time;
      });

      renderTasks(currentShift);
      document.getElementById('taskList').classList.remove('hidden');
      document.getElementById('sendBtn').classList.remove('hidden');
	  document.getElementById('unsaveBtn').classList.remove('hidden');

    }
  } catch (err) {
    console.error("Auto-load error:", err);
  }
  
  
});

</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js">
window.addEventListener('DOMContentLoaded', async () => {
  const today = new Date().toLocaleDateString('en-US');
  const docId = `${today}_AM`;

  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (docSnap.exists) {
      const report = docSnap.data();
      currentShift = report.shift;
      timestamps = {};
      checkedStates = {};

employeeIds = {}; // clear previous data
tasks[report.shift].forEach((taskName, i) => {
  const id = `${report.shift}_task${i}`;
  const savedTask = report.tasks.find(t => t.name === taskName);
  if (savedTask) {
    checkedStates[id] = savedTask.checked;
    timestamps[id] = savedTask.time;
    employeeIds[id] = savedTask.employee || "Unknown"; // ✅ this line is the new part
  }
});



      renderTasks(currentShift);
      document.getElementById('taskList').classList.remove('hidden');
      document.getElementById('sendBtn').classList.remove('hidden');
	  document.getElementById('unsaveBtn').classList.remove('hidden');

    }
  } catch (err) {
    console.error("Auto-load error:", err);
  }
});


</script>
</head>
<body>
<div class="container">

  <h2 id="headerTitle">Shift Task Tracker - <span id="currentDate"></span></h2>

  <div class="button-row">
    <button onclick="selectShift('AM')">AM</button>
    <button onclick="selectShift('PM')">PM</button>
    <button onclick="selectShift('DATA')">DATA</button>
  </div>
  
  <!-- Insert this block directly below the AM/PM/DATA buttons -->
<div class="button-row" id="employeeRow">
  <label><input type="radio" name="employeeId" value="BG"> BG</label>
  <label><input type="radio" name="employeeId" value="BJ"> BJ</label>
  <label><input type="radio" name="employeeId" value="CG"> CG</label>
  <label><input type="radio" name="employeeId" value="SG"> SG</label>
</div>

<style>
#employeeRow {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  font-size: 16px;
}
#employeeRow label {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
}
</style>


  <div id="taskList" class="hidden"></div>

<div id="dataControls" class="hidden">
  <label for="dataShiftSelect">Shift:</label>
  <select id="dataShiftSelect">
    <option value="AM">AM</option>
    <option value="PM">PM</option>
  </select>

  <label for="manualDatePicker">Select Date:</label>
  <input type="date" id="manualDatePicker" style="width: 160px;">

  <label for="manualDate">or enter date:</label>
  <input type="text" id="manualDate" style="width: 120px;">


  <button class="styled-button" onclick="loadSelectedData()">View Report</button>

</div>


  <div id="dataView" class="hidden"></div>

  <button id="sendBtn" class="hidden">Save Report</button>
  <button id="unsaveBtn" class="hidden">Unsave Checked</button>


  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.firebasestorage.app",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ⬇️ Set calendar default to today
window.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
  document.getElementById('manualDatePicker').value = today;
});

// Set today's date as the placeholder for the manual date input
const manualDateInput = document.getElementById('manualDate');
const today = new Date().toLocaleDateString('en-US');
manualDateInput.placeholder = today;


    const tasks = {
      AM: [
        'Aired Males',
        'Aired Females',
        'Morning Feed',
        'Medicine',
        'Checked Chlorine Gun Young',
        'Cleaned Young Dog Kennel',
        'Checked Chlorine Gun Old',
        'Cleaned Finished Dog Kennel',
        'Turned Off Water Young Dog Kennel',
        'Turned Off Water Finished Dog Kennel',
		'Cleaned Airing Lots',
        'Clipped Gates'
             ],
      PM: ['Medicine', 'Fed Dogs', 'Aired Males (Old)', 'Aired Females (Old)', 'Aired Males (Young)', 'Aired Females (Young)', 'Cleaned Airing Yards', 'Clip/Dog Check (Old)', 'Clip/Dog Check (Young)', 'Water Hose Check (Old)', 'Water Hose Check (Young)', 'Water Off Check (Old)', 'Water Off Check (Young)', 'Trailer Holes Empty/Clean', 'Washed Bowls', 'Clipped Gates']
    };

    let currentShift = null;
    let timestamps = {};
    let checkedStates = {};
	let employeeIds = {};

    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US');

    async function selectShift(mode) {
      const taskList = document.getElementById('taskList');
      const dataView = document.getElementById('dataView');
      const dataControls = document.getElementById('dataControls');
      const sendBtn = document.getElementById('sendBtn');

      if (mode === 'DATA') {
  currentShift = null;
  taskList.classList.add('hidden');
  sendBtn.classList.add('hidden');
  document.getElementById('unsaveBtn').classList.add('hidden'); // ✅ Hide unsave button
  dataControls.classList.remove('hidden');
  dataView.classList.remove('hidden');
  dataView.innerHTML = '';
}
 else {
        currentShift = mode;
        timestamps = {};
        checkedStates = {};
        const today = new Date().toLocaleDateString('en-US');
        const docId = `${today}_${mode}`;
        try {
          const docSnap = await db.collection("reports").doc(docId).get();
          if (docSnap.exists) {
            const report = docSnap.data();
employeeIds = {}; // clear previous data
tasks[report.shift].forEach((taskName, i) => {
  const id = `${report.shift}_task${i}`;
  const savedTask = report.tasks.find(t => t.name === taskName);
  if (savedTask) {
    checkedStates[id] = savedTask.checked;
    timestamps[id] = savedTask.time;
    employeeIds[id] = savedTask.employee || "Unknown"; // ✅ this line is the new part
  }
});


            console.log("Restored saved data for", docId);
          } else {
            console.log("No saved data for", docId);
          }
        } catch (e) {
          console.error("Error checking saved report:", e);
        }
        renderTasks(mode);
        taskList.classList.remove('hidden');
        sendBtn.classList.remove('hidden');
document.getElementById('unsaveBtn').classList.remove('hidden');

        dataControls.classList.add('hidden');
        dataView.classList.add('hidden');
      }
    }

    function renderTasks(shift) {
      const container = document.getElementById('taskList');
      container.innerHTML = '';

      tasks[shift].forEach((task, i) => {
        const id = `${shift}_task${i}`;
        const div = document.createElement('div');
        div.className = 'task';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.checked = checkedStates[id] || false;

        checkbox.onchange = () => {
          const now = new Date().toLocaleTimeString();
          checkedStates[id] = checkbox.checked;
          timestamps[id] = now;
          document.getElementById(`ts_${id}`).textContent = checkbox.checked
            ? `${now}`
            : 'Unchecked';
        };

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = task;

        const tsSpan = document.createElement('span');
        tsSpan.id = `ts_${id}`;
        tsSpan.className = 'timestamp';
        tsSpan.textContent = checkbox.checked
          ? `${timestamps[id] || "Now"}`
          : 'Unchecked';

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(tsSpan);

        container.appendChild(div);
      });
    }

async function saveReport() {
  if (!currentShift) return;

  const employeeRadios = document.getElementsByName('employeeId');
  let selectedEmployee = null;
  for (let radio of employeeRadios) {
    if (radio.checked) {
      selectedEmployee = radio.value;
      break;
    }
  }

  if (!selectedEmployee) {
    alert("Please select your employee ID before saving.");
    return;
  }

  const date = new Date().toLocaleDateString('en-US');
  const data = [];

  console.log(`--- Saving Report for ${date} (${currentShift}) ---`);

  tasks[currentShift].forEach((task, i) => {
    const id = `${currentShift}_task${i}`;
    const checkbox = document.getElementById(id);

    if (checkbox?.checked) {
      const time = timestamps[id] || new Date().toLocaleTimeString();
      const entry = { name: task, time, checked: true, employee: selectedEmployee };
      data.push(entry);
      console.log(`✓ Saving: "${task}" at ${time} by ${selectedEmployee}`);
    }
  });

  const docId = `${date}_${currentShift}`;
  console.log(`Writing to Firebase:`, data);

  await db.collection("reports").doc(docId).set({
    date,
    shift: currentShift,
    tasks: data
  });

  alert("Report saved to Firebase!");
}


async function unsaveChecked() {
  if (!currentShift) return;

  const date = new Date().toLocaleDateString('en-US');
  const docId = `${date}_${currentShift}`;

  try {
    const docSnap = await db.collection("reports").doc(docId).get();
    if (!docSnap.exists) {
      alert("No saved report found to update.");
      return;
    }

    let existingTasks = docSnap.data().tasks || [];
    const toRemove = [];

    tasks[currentShift].forEach((task, i) => {
      const id = `${currentShift}_task${i}`;
      const checkbox = document.getElementById(id);
      if (checkbox?.checked) {
        toRemove.push(task);
      }
    });

    const updatedTasks = existingTasks.filter(t => !toRemove.includes(t.name));

    await db.collection("reports").doc(docId).update({ tasks: updatedTasks });

    alert("Selected tasks removed from saved report.");
    await selectShift(currentShift); // Refresh view
  } catch (err) {
    console.error("Error during unsave:", err);
    alert("Failed to update report.");
  }
}



async function loadSelectedData() {
  const datePickerValue = document.getElementById('manualDatePicker').value;
  const manualDateValue = document.getElementById('manualDate').value.trim();
  const shift = document.getElementById('dataShiftSelect').value;
  const dataView = document.getElementById('dataView');

  const dateToUse = datePickerValue || manualDateValue;
  if (!dateToUse) return alert("Please select or enter a date.");

  let formattedDate;
if (datePickerValue) {
  const [year, month, day] = datePickerValue.split("-");
  formattedDate = `${parseInt(month)}/${parseInt(day)}/${year}`;
} else {
  formattedDate = new Date(manualDateValue).toLocaleDateString('en-US');
}

  const docId = `${formattedDate}_${shift}`;
  dataView.innerHTML = '';

  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (!docSnap.exists) {
      dataView.innerHTML = `<p>No data found for ${formattedDate} (${shift}).</p>`;
      console.warn("No document found for ID:", docId);
      return;
    }

    const report = docSnap.data();
    console.log(`Loaded from Firebase [${docId}]:`, report.tasks);

  dataView.innerHTML = `
  <strong>Date:</strong> ${report.date}<br>
  <strong>Shift:</strong> ${report.shift}<br>
  <ul>
    ${report.tasks.map(t => {
      const timeStr = t.checked ? t.time : "Not completed";
      const emp = t.employee || "Unknown";
      return `<li>${t.name} - ${timeStr} <em>(by ${emp})</em></li>`;
    }).join('')}
  </ul>
`;

  } catch (err) {
    console.error("Error loading report:", err);
    dataView.innerHTML = `<p style="color:red;">Error loading data.</p>`;
  }
}



    document.getElementById('sendBtn').addEventListener('click', saveReport);
	document.getElementById('unsaveBtn').addEventListener('click', unsaveChecked);
document.getElementById('manualDatePicker').addEventListener('change', () => {
  document.getElementById('manualDate').value = '';
});

  
window.addEventListener('DOMContentLoaded', async () => {
  const today = new Date().toLocaleDateString('en-US');
  const docId = `${today}_AM`;

  try {
    const docSnap = await db.collection("reports").doc(docId).get();

    if (docSnap.exists) {
      const report = docSnap.data();
      currentShift = report.shift;
      timestamps = {};
      checkedStates = {};

employeeIds = {}; // clear previous data
tasks[report.shift].forEach((taskName, i) => {
  const id = `${report.shift}_task${i}`;
  const savedTask = report.tasks.find(t => t.name === taskName);
  if (savedTask) {
    checkedStates[id] = savedTask.checked;
    timestamps[id] = savedTask.time;
    employeeIds[id] = savedTask.employee || "Unknown"; // ✅ this line is the new part
  }
});



      renderTasks(currentShift);
      document.getElementById('taskList').classList.remove('hidden');
      document.getElementById('sendBtn').classList.remove('hidden');
	  document.getElementById('unsaveBtn').classList.remove('hidden');

    }
  } catch (err) {
    console.error("Auto-load error:", err);
  }
});

</script>

</div>
</body>
</html>
