<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Task Tracker</title>
  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, getDocs, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // âœ… Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.firebasestorage.app",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // App logic
    const tasks = {
      AM: ['Task 1', 'Task 2', 'Task 3'],
      PM: ['Task 4', 'Task 5', 'Task 6']
    };

    let currentShift = null;
    let timestamps = {};
    let checkedStates = {};

    function selectShift(mode) {
      const taskList = document.getElementById('taskList');
      const dataView = document.getElementById('dataView');
      const dataControls = document.getElementById('dataControls');
      const sendBtn = document.getElementById('sendBtn');

      if (mode === 'DATA') {
        currentShift = null;
        taskList.classList.add('hidden');
        sendBtn.classList.add('hidden');
        dataControls.classList.remove('hidden');
        dataView.classList.remove('hidden');
        populateDataOptions();
        dataView.innerHTML = '';
      } else {
        currentShift = mode;
        timestamps = {};
        checkedStates = {};
        renderTasks(mode);
        taskList.classList.remove('hidden');
        sendBtn.classList.remove('hidden');
        dataControls.classList.add('hidden');
        dataView.classList.add('hidden');
      }
    }

    function renderTasks(shift) {
      const container = document.getElementById('taskList');
      container.innerHTML = '';

      tasks[shift].forEach((task, i) => {
        const id = `${shift}_task${i}`;
        const div = document.createElement('div');
        div.className = 'task';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.checked = checkedStates[id] || false;

        checkbox.onchange = () => {
          const now = new Date().toLocaleTimeString();
          checkedStates[id] = checkbox.checked;
          timestamps[id] = now;
          document.getElementById(`ts_${id}`).textContent = checkbox.checked
            ? `Last checked: ${now}`
            : 'Unchecked';
        };

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = task;

        const tsSpan = document.createElement('span');
        tsSpan.id = `ts_${id}`;
        tsSpan.className = 'timestamp';
        tsSpan.textContent = checkbox.checked
          ? `Last checked: ${timestamps[id] || "Now"}`
          : 'Unchecked';

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(tsSpan);

        container.appendChild(div);
      });
    }

    async function saveReport() {
      if (!currentShift) return;

      const date = new Date().toLocaleDateString();
      const data = [];

      tasks[currentShift].forEach((task, i) => {
        const id = `${currentShift}_task${i}`;
        const time = timestamps[id] || "Never";
        const checked = checkedStates[id] || false;
        data.push({ name: task, time, checked });
      });

      const docId = `${date}_${currentShift}`;
      const reportRef = doc(db, "reports", docId);

      await setDoc(reportRef, {
        date,
        shift: currentShift,
        tasks: data
      });

      alert("Report saved to Firebase!");
    }

    async function populateDataOptions() {
      const dateSelect = document.getElementById('dateSelect');
      dateSelect.innerHTML = '';

      const snapshot = await getDocs(collection(db, "reports"));
      const uniqueDates = new Set();

      snapshot.forEach(doc => {
        uniqueDates.add(doc.data().date);
      });

      [...uniqueDates].forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
    }

    async function loadSelectedData() {
      const date = document.getElementById('dateSelect').value;
      const shift = document.getElementById('dataShiftSelect').value;
      const dataView = document.getElementById('dataView');

      const q = query(collection(db, "reports"), where("date", "==", date), where("shift", "==", shift));
      const snapshot = await getDocs(q);

      dataView.innerHTML = '';

      if (snapshot.empty) {
        dataView.innerHTML = '<p>No data found for that date and shift.</p>';
        return;
      }

      snapshot.forEach(doc => {
        const report = doc.data();
        dataView.innerHTML = `
          <strong>Date:</strong> ${report.date}<br>
          <strong>Shift:</strong> ${report.shift}<br>
          <ul>
            ${report.tasks.map(t =>
              `<li>${t.name} - ${t.checked ? t.time : "Not completed"}</li>`
            ).join('')}
          </ul>
        `;
      });
    }

    window.selectShift = selectShift;
    window.loadSelectedData = loadSelectedData;
    window.saveReport = saveReport;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
      document.getElementById('sendBtn').addEventListener('click', saveReport);
    });
  </script>

  <style>
    body { font-family: Arial; padding: 20px; }
    .task { margin: 10px 0; }
    .timestamp { margin-left: 10px; font-size: 0.9em; color: gray; }
    .hidden { display: none; }
    .button-row button {
      margin: 0 5px 10px 0;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2 id="headerTitle">Shift Task Tracker - <span id="currentDate"></span></h2>

  <div class="button-row">
    <button onclick="selectShift('AM')">AM</button>
    <button onclick="selectShift('PM')">PM</button>
    <button onclick="selectShift('DATA')">DATA</button>
  </div>

  <div id="taskList" class="hidden"></div>

  <div id="dataControls" class="hidden">
    <label for="dateSelect">Date:</label>
    <select id="dateSelect"></select>

    <label for="dataShiftSelect">Shift:</label>
    <select id="dataShiftSelect">
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>

    <button onclick="loadSelectedData()">View Report</button>
  </div>

  <div id="dataView" class="hidden"></div>

  <button id="sendBtn" class="hidden">Save Report</button>

</body>
</html>
