<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dog Food Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea, select {
      width: 100%;
      box-sizing: border-box;
    }
    .section {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .column {
      flex: 1;
      min-width: 120px;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
    }
    .cup-btn {
      width: 60px;
      display: block;
      margin-bottom: 5px;
    }
    .custom-listbox {
      border: 1px solid #aaa;
      height: 160px;
      overflow-y: auto;
      padding: 5px;
      background: #fff;
    }
    .custom-listbox div {
      padding: 4px;
      cursor: pointer;
    }
    .custom-listbox div:hover {
      background-color: #eef;
    }
    .custom-listbox .selected {
      background-color: #ccf;
    }
  </style>
</head>
<body>
  <h2>Dog Food Tracker</h2>
  <div class="section">
    <h3>Dog Groups</h3>
    <div class="flex-row">
      <div class="column">
        <label><input type="radio" name="editGroup" value="oldMales" checked> Old Males</label><br/>
        <label><input type="radio" name="editGroup" value="oldFemales"> Old Females</label><br/>
        <label><input type="radio" name="editGroup" value="youngMales"> Young Males</label><br/>
        <label><input type="radio" name="editGroup" value="youngFemales"> Young Females</label>
      </div>
      <div class="column">
        <textarea id="editGroupBox" rows="8"></textarea>
      </div>
    </div>
    <button onclick="saveDogGroups()" style="background-color: green; color: white;">üíæ Save</button>
  </div>

  <div class="section">
    <h3>Assign Dogs to Cup Sizes</h3>
    <div class="flex-row">
      <div class="column">
        <label><input type="radio" name="group" value="oldMales" checked> Old Males</label><br/>
        <label><input type="radio" name="group" value="oldFemales"> Old Females</label><br/>
        <label><input type="radio" name="group" value="youngMales"> Young Males</label><br/>
        <label><input type="radio" name="group" value="youngFemales"> Young Females</label>
      </div>
      <div class="column">
        <div id="dogListBox" class="custom-listbox"></div>
      </div>
      <div class="column">
        <button onclick="assignCup(2)" class="cup-btn">2</button>
        <button onclick="assignCup(3)" class="cup-btn">3</button>
        <button onclick="assignCup(4)" class="cup-btn">4</button>
        <button onclick="unassignDog()" class="cup-btn">‚Üê</button>
      </div>
      <div class="column">
        <label>2 Cups</label><select id="cup2" size="8"></select>
        <label>3 Cups</label><select id="cup3" size="8"></select>
        <label>4 Cups</label><select id="cup4" size="8"></select>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAqPT52Us-vWv4GNRYPgGCQ2I1SdsLsXyI",
      authDomain: "task-tracker-73b77.firebaseapp.com",
      projectId: "task-tracker-73b77",
      storageBucket: "task-tracker-73b77.appspot.com",
      messagingSenderId: "795274673000",
      appId: "1:795274673000:web:0ea07130e45c72384134dd",
      measurementId: "G-VLW5KLY4FF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function loadDogGroupEditor() {
      const selected = document.querySelector('input[name="editGroup"]:checked').value;
      db.collection('dogFood').doc('dogGroups').get().then(doc => {
        if (doc.exists && doc.data()[selected]) {
          const data = doc.data()[selected];
          document.getElementById('editGroupBox').value = Array.isArray(data) ? data.join('\n') : data;
        }
      });
    }

    document.querySelectorAll('input[name="editGroup"]').forEach(radio =>
      radio.addEventListener('change', loadDogGroupEditor)
    );

    function saveDogGroups() {
      const selected = document.querySelector('input[name="editGroup"]:checked').value;
      const currentGroupData = document.getElementById('editGroupBox').value.split('\n').map(x => x.trim()).filter(Boolean);
      return db.collection('dogFood').doc('dogGroups').get().then(doc => {
        const existing = doc.exists ? doc.data() : {};
        const updated = {
          ...existing,
          [selected]: currentGroupData,
          cup2: getCupListValues('cup2'),
          cup3: getCupListValues('cup3'),
          cup4: getCupListValues('cup4'),
        };
        return db.collection('dogFood').doc('dogGroups').set(updated).then(() => updated);
      });
    }

    function getDogGroupData() {
      return db.collection("dogFood").doc("dogGroups").get().then(doc => doc.exists ? doc.data() : {});
    }

    function loadCupAssignments(data) {
      ['cup2', 'cup3', 'cup4'].forEach(cup => {
        const cupBox = document.getElementById(cup);
        cupBox.innerHTML = '';
        (data[cup] || []).forEach(name => {
          const option = document.createElement('option');
          option.value = option.text = name;
          cupBox.appendChild(option);
        });
      });
    }

    async function autoSaveAndRefresh() {
      await saveDogGroups();
      loadCupAssignments(await getDogGroupData());
      loadDogList();
    }

    function loadDogList() {
      const selected = document.querySelector('input[name="group"]:checked').value;
      db.collection('dogFood').doc('dogGroups').get().then(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        let raw = data[selected] || [];
        if (!Array.isArray(raw)) raw = String(raw).split('\n');
        const groupDogs = raw.map(name => name.trim()).filter(Boolean);
        const assigned = new Set([...(data.cup2 || []), ...(data.cup3 || []), ...(data.cup4 || [])]);
        const unassignedDogs = groupDogs.filter(name => !assigned.has(name));

        const box = document.getElementById('dogListBox');
        box.innerHTML = '';
        unassignedDogs.forEach(name => {
          const div = document.createElement('div');
          div.textContent = name;
          div.onclick = () => {
            document.querySelectorAll('#dogListBox div').forEach(d => d.classList.remove('selected'));
            div.classList.add('selected');
            box.dataset.selected = name;
          };
          box.appendChild(div);
        });
      });
    }

    function assignCup(cup) {
      const box = document.getElementById('dogListBox');
      const name = box.dataset.selected;
      if (!name) return;

      [2, 3, 4].forEach(c => {
        const list = document.getElementById('cup' + c);
        Array.from(list.options).forEach(opt => {
          if (opt.value === name) list.remove(opt.index);
        });
      });

      const cupBox = document.getElementById('cup' + cup);
      const option = document.createElement('option');
      option.value = option.text = name;
      cupBox.appendChild(option);

      delete box.dataset.selected;
      document.querySelectorAll('#dogListBox div').forEach(d => {
        if (d.textContent === name) d.remove();
      });

      autoSaveAndRefresh();
    }

    function unassignDog() {
      let name = null, foundCup = null;
      [2, 3, 4].forEach(c => {
        const cupList = document.getElementById('cup' + c);
        const selected = cupList.options[cupList.selectedIndex];
        if (selected && !name) {
          name = selected.value;
          foundCup = cupList;
        }
      });
      if (!name || !foundCup) return alert("Select a name from a cup list.");

      foundCup.remove(foundCup.selectedIndex);

      const dogList = document.getElementById('dogListBox');
      const div = document.createElement('div');
      div.textContent = name;
      div.onclick = () => {
        document.querySelectorAll('#dogListBox div').forEach(d => d.classList.remove('selected'));
        div.classList.add('selected');
        dogList.dataset.selected = name;
      };
      dogList.appendChild(div);

      autoSaveAndRefresh();
    }

    function getCupListValues(id) {
      return Array.from(document.getElementById(id).options).map(opt => opt.value);
    }

    document.addEventListener('DOMContentLoaded', () => {
      db.collection("dogFood").doc("dogGroups").get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          loadCupAssignments(data);
          const currentGroup = document.querySelector('input[name="editGroup"]:checked')?.value;
          const groupEditorBox = document.getElementById('editGroupBox');
          if (currentGroup && groupEditorBox && data[currentGroup]) {
            const lines = Array.isArray(data[currentGroup]) ? data[currentGroup] : String(data[currentGroup]).split('\n');
            groupEditorBox.value = lines.join('\n');
          }
          loadDogList();
        }
      }).catch(console.error);
    });

    document.querySelectorAll('input[name="group"]').forEach(radio =>
      radio.addEventListener('change', loadDogList)
    );
  </script>
</body>
</html>
